# ============================================================================
# U.S. Government Geographic Data Schema
# ============================================================================
# Data Sources:
#   - Census TIGER/Line shapefiles (boundaries)
#   - HUD USPS ZIP Code Crosswalk (crosswalks)
#   - Census API (demographics)
#
# Features:
#   - Hive-style partitioning for efficient querying
#   - Shapefile-to-Parquet conversion via DuckDB spatial
#   - Iceberg materialization support
# ============================================================================

schemaName: "${SCHEMA_NAME:geo}"
dataLagYears: 0
materializeDirectory: "${GOVDATA_PARQUET_DIR}/source=geo"
refreshInterval: "PT1H"

comment: >
  U.S. government geographic data including Census TIGER boundaries, HUD USPS ZIP code
  crosswalks, and demographic statistics. Enables spatial analysis, geographic aggregation,
  and crosswalk between ZIP codes, counties, census tracts, congressional districts, and
  metropolitan areas.

# ============================================================================
# HOOKS CONFIGURATION
# ============================================================================
# Response transformers for different data sources:
# - TIGER tables: Use TigerDataDownloader directly (binary shapefiles)
# - HUD tables: Use HudCrosswalkTransformer via HTTP source (JSON APIs)
# ============================================================================

# Note: Global hooks removed - each table specifies its own hooks

# ============================================================================
# COLUMN TEMPLATES
# ============================================================================
# Reusable column definitions using YAML anchors
# ============================================================================

column_templates:

  # --- Geographic Identifier Columns ---

  state_fips_column: &state_fips_column
    name: state_fips
    type: string
    nullable: false
    comment: 2-digit FIPS code identifying the state (e.g., '06' for California)

  county_fips_column: &county_fips_column
    name: county_fips
    type: string
    nullable: false
    comment: 5-digit FIPS code for county (state + county, e.g., '06037' for Los Angeles County)

  geometry_column: &geometry_column
    name: geometry
    type: string
    nullable: true
    comment: WKT representation of boundary polygon

  land_area_column: &land_area_column
    name: land_area
    type: double
    nullable: true
    comment: Land area in square meters

  water_area_column: &water_area_column
    name: water_area
    type: double
    nullable: true
    comment: Water area in square meters

  # --- Partition Column Definitions ---

  partition_type: &partition_type
    name: type
    type: VARCHAR

  partition_year: &partition_year
    name: year
    type: INTEGER

  # --- Standard Partition Set ---

  boundary_partitions: &boundary_partitions
    style: hive
    columnDefinitions:
      - *partition_type
      - *partition_year

  crosswalk_partitions: &crosswalk_partitions
    style: hive
    columnDefinitions:
      - *partition_type
      - *partition_year

# ============================================================================
# DIMENSION VALUES
# ============================================================================
# Reusable dimension value lists
# ============================================================================

dimension_values:

  # --- Year Range for TIGER data ---
  # TIGER 2024/2025 data not yet available in early 2026, use dataLag: 3 to only request 2023
  tiger_year_range: &tiger_year_range
    type: yearRange
    start: "${GOVDATA_START_YEAR:2020}"
    dataLag: 3

  # --- Year Range for HUD crosswalk data ---
  # HUD crosswalk updates quarterly with ~3 year lag (2024/2025 data not yet available in 2026)
  hud_year_range: &hud_year_range
    type: yearRange
    start: "${GOVDATA_START_YEAR:2020}"
    dataLag: 3

  # All 50 states + DC (FIPS 01-56, excluding 03, 07, 14, 43, 52)
  all_state_fips: &all_state_fips
    - '01'
    - '02'
    - '04'
    - '05'
    - '06'
    - '08'
    - '09'
    - '10'
    - '11'
    - '12'
    - '13'
    - '15'
    - '16'
    - '17'
    - '18'
    - '19'
    - '20'
    - '21'
    - '22'
    - '23'
    - '24'
    - '25'
    - '26'
    - '27'
    - '28'
    - '29'
    - '30'
    - '31'
    - '32'
    - '33'
    - '34'
    - '35'
    - '36'
    - '37'
    - '38'
    - '39'
    - '40'
    - '41'
    - '42'
    - '44'
    - '45'
    - '46'
    - '47'
    - '48'
    - '49'
    - '50'
    - '51'
    - '53'
    - '54'
    - '55'
    - '56'

# ============================================================================
# MATERIALIZATION OPTIONS
# ============================================================================
# Default materialization settings for all tables
# ============================================================================

materializationDefaults:
  format: iceberg
  options:
    warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
    icebergTableName: "${TABLE_NAME}"
    partitionBy:
      - type
      - year
    emptyResultTtlDays: 7
    errorRetryDays: 1
  iceberg:
    catalogType: hadoop
    # Automatic compaction - consolidates many small state-level files into fewer large files
    # This runs after commit to merge dimension-level downloads into partition-optimized files
    runCompaction: true
    compactionTargetFileSizeBytes: 134217728  # 128MB
    compactionMinFiles: 5  # Compact if partition has 5+ small files (lower than econ due to state downloads)
    compactionSmallFileSizeBytes: 10485760  # 10MB - files under this are "small"
    runMaintenance: true
    snapshotRetentionDays: 7

# ============================================================================
# TIGER BOUNDARY TABLES
# ============================================================================

partitionedTables:

  # --------------------------------------------------------------------------
  # States - U.S. state boundaries
  # --------------------------------------------------------------------------
  - name: states
    pattern: "type=boundary/year=*/states.parquet"
    comment: >
      U.S. state boundaries and attributes from TIGER/Line shapefiles. Includes state
      FIPS codes, names, areas, and geographic boundaries. Updated annually with official
      Census Bureau boundaries.

    columns:
      - <<: *state_fips_column
      - name: state_code
        type: string
        nullable: false
        comment: Geographic identifier (GEOID) for the state, matches state_fips
      - name: state_name
        type: string
        nullable: false
        comment: Full state name (e.g., 'California')
      - name: state_abbr
        type: string
        nullable: false
        comment: 2-letter postal abbreviation (e.g., 'CA')
      - <<: *land_area_column
      - <<: *water_area_column
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [state_fips, year]
      unique:
        - [state_code, year]
        - [state_name, year]

    dimensions:
      type:
        - boundary
      year: *tiger_year_range

    # TIGER tables use TigerDataProvider for binary shapefile handling
    source:
      type: http
      url: "https://www2.census.gov/geo/tiger/TIGER{year}/STATE/tl_{year}_us_state.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.TigerDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=boundary/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: states
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # Counties - U.S. county boundaries
  # --------------------------------------------------------------------------
  - name: counties
    pattern: "type=boundary/year=*/counties.parquet"
    comment: >
      U.S. county boundaries and attributes including FIPS codes, names, metropolitan
      statistical areas, and geographic boundaries. Contains all 3,000+ counties and
      county equivalents.

    columns:
      - <<: *county_fips_column
      - <<: *state_fips_column
      - name: county_name
        type: string
        nullable: false
        comment: Full county name (e.g., 'Los Angeles County')
      - name: county_code
        type: string
        nullable: false
        comment: Geographic identifier (GEOID) for the county
      - <<: *land_area_column
      - <<: *water_area_column
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [county_fips, year]
      foreignKeys:
        - columns: [state_fips]
          targetTable: states
          targetColumns: [state_fips]

    dimensions:
      type:
        - boundary
      year: *tiger_year_range

    # TIGER tables use TigerDataProvider for binary shapefile handling
    source:
      type: http
      url: "https://www2.census.gov/geo/tiger/TIGER{year}/COUNTY/tl_{year}_us_county.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.TigerDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=boundary/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: counties
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # Places - Census designated places (cities, towns)
  # --------------------------------------------------------------------------
  - name: places
    pattern: "type=boundary/year=*/places.parquet"
    comment: >
      Census designated places including cities, towns, and villages. Contains place
      boundaries, population classifications, and geographic identifiers for incorporated
      and census-designated places.

    columns:
      - name: place_fips
        type: string
        nullable: false
        comment: 7-digit FIPS code for place (state + place code)
      - <<: *state_fips_column
      - name: place_name
        type: string
        nullable: false
        comment: Name of incorporated place or census-designated place
      - name: place_type
        type: string
        nullable: true
        comment: Classification of place (e.g., 'city', 'town', 'CDP')
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [place_fips, year]
      foreignKeys:
        - columns: [state_fips]
          targetTable: states
          targetColumns: [state_fips]

    dimensions:
      type:
        - boundary
      year: *tiger_year_range
      state_fips: *all_state_fips

    # TIGER tables use TigerDataProvider for binary shapefile handling
    source:
      type: http
      url: "https://www2.census.gov/geo/tiger/TIGER{year}/PLACE/tl_{year}_{state_fips}_place.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.TigerDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=boundary/year=*/state_fips=*/"
      partition:
        columns: [type, year, state_fips]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: places
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # ZCTAs - ZIP Code Tabulation Areas
  # --------------------------------------------------------------------------
  - name: zctas
    pattern: "type=boundary/year=*/zctas.parquet"
    comment: >
      ZIP Code Tabulation Areas (ZCTAs) approximating USPS ZIP Code delivery areas.
      Includes ZCTA boundaries and relationships to other geographic entities.

    columns:
      - name: zcta
        type: string
        nullable: false
        comment: 5-digit ZIP Code Tabulation Area code
      - <<: *land_area_column
      - <<: *water_area_column
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [zcta, year]

    dimensions:
      type:
        - boundary
      year: *tiger_year_range

    # TIGER tables use TigerDataProvider for binary shapefile handling
    source:
      type: http
      url: "https://www2.census.gov/geo/tiger/TIGER{year}/ZCTA520/tl_{year}_us_zcta520.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.TigerDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=boundary/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: zctas
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # Census Tracts - Statistical subdivisions of counties
  # --------------------------------------------------------------------------
  - name: census_tracts
    pattern: "type=boundary/year=*/census_tracts.parquet"
    comment: >
      Census tract boundaries - small statistical subdivisions of counties averaging
      4,000 inhabitants. Key geography for demographic analysis and census data reporting.

    columns:
      - name: tract_fips
        type: string
        nullable: false
        comment: 11-digit FIPS code for census tract (state + county + tract)
      - <<: *state_fips_column
      - <<: *county_fips_column
      - name: tract_name
        type: string
        nullable: true
        comment: Census tract number (e.g., '4201.02')
      - <<: *land_area_column
      - <<: *water_area_column
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [tract_fips, year]
      foreignKeys:
        - columns: [county_fips]
          targetTable: counties
          targetColumns: [county_fips]

    dimensions:
      type:
        - boundary
      year: *tiger_year_range
      state_fips: *all_state_fips

    # TIGER tables use TigerDataProvider for binary shapefile handling
    source:
      type: http
      url: "https://www2.census.gov/geo/tiger/TIGER{year}/TRACT/tl_{year}_{state_fips}_tract.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.TigerDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=boundary/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: census_tracts
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # Block Groups - Smallest census geography with sample data
  # --------------------------------------------------------------------------
  - name: block_groups
    pattern: "type=boundary/year=*/block_groups.parquet"
    comment: >
      Census block groups - statistical divisions of census tracts, generally containing
      600-3,000 people. Smallest geography for which census sample data is published.

    columns:
      - name: block_group_fips
        type: string
        nullable: false
        comment: 12-digit FIPS code for block group (state + county + tract + block group)
      - <<: *state_fips_column
      - <<: *county_fips_column
      - name: tract_fips
        type: string
        nullable: false
        comment: 11-digit FIPS code of the parent census tract
      - <<: *land_area_column
      - <<: *water_area_column
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [block_group_fips, year]
      foreignKeys:
        - columns: [tract_fips]
          targetTable: census_tracts
          targetColumns: [tract_fips]

    dimensions:
      type:
        - boundary
      year: *tiger_year_range
      state_fips: *all_state_fips

    # TIGER tables use TigerDataProvider for binary shapefile handling
    source:
      type: http
      url: "https://www2.census.gov/geo/tiger/TIGER{year}/BG/tl_{year}_{state_fips}_bg.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.TigerDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=boundary/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: block_groups
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # CBSAs - Core Based Statistical Areas (metros/micros)
  # --------------------------------------------------------------------------
  - name: cbsa
    pattern: "type=boundary/year=*/cbsa.parquet"
    comment: >
      Core Based Statistical Areas including Metropolitan and Micropolitan Statistical
      Areas. Defines urban cores and surrounding counties with social and economic ties.

    columns:
      - name: cbsa_fips
        type: string
        nullable: false
        comment: 5-digit CBSA code for Core Based Statistical Area
      - name: cbsa_name
        type: string
        nullable: false
        comment: Name of metropolitan or micropolitan statistical area
      - name: metro_micro
        type: string
        nullable: true
        comment: LSAD code indicating Metropolitan or Micropolitan designation
      - <<: *land_area_column
      - <<: *water_area_column
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [cbsa_fips, year]
      unique:
        - [cbsa_name, year]

    dimensions:
      type:
        - boundary
      year: *tiger_year_range

    # TIGER tables use TigerDataProvider for binary shapefile handling
    source:
      type: http
      url: "https://www2.census.gov/geo/tiger/TIGER{year}/CBSA/tl_{year}_us_cbsa.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.TigerDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=boundary/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: cbsa
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # Congressional Districts
  # --------------------------------------------------------------------------
  - name: congressional_districts
    pattern: "type=boundary/year=*/congressional_districts.parquet"
    comment: >
      U.S. Congressional district boundaries for the House of Representatives.
      Updated after each decennial census reapportionment and subsequent redistricting.

    columns:
      - name: cd_fips
        type: string
        nullable: false
        comment: 4-digit congressional district code (state + district number)
      - <<: *state_fips_column
      - name: cd_name
        type: string
        nullable: true
        comment: Congressional district name or number
      - <<: *land_area_column
      - <<: *water_area_column
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [cd_fips, year]
      foreignKeys:
        - columns: [state_fips]
          targetTable: states
          targetColumns: [state_fips]

    dimensions:
      type:
        - boundary
      year:
        type: yearRange
        start: "2023"
        end: "2023"
        dataLag: 0
      state_fips: *all_state_fips

    # TIGER tables use TigerDataProvider for binary shapefile handling
    # Note: cd118 = 118th Congress (2023-2024), cd119 = 119th Congress (2025-2026)
    source:
      type: http
      url: "https://www2.census.gov/geo/tiger/TIGER{year}/CD/tl_{year}_{state_fips}_cd118.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.TigerDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=boundary/year=*/state_fips=*/"
      partition:
        columns: [type, year, state_fips]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: congressional_districts
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # School Districts
  # --------------------------------------------------------------------------
  - name: school_districts
    pattern: "type=boundary/year=*/school_districts.parquet"
    comment: >
      Elementary, secondary, and unified school district boundaries. Includes district
      codes, names, and relationships to other geographic entities.

    columns:
      - name: sd_lea
        type: string
        nullable: false
        comment: Local Education Agency (LEA) code identifying the school district
      - <<: *state_fips_column
      - name: sd_name
        type: string
        nullable: true
        comment: School district name
      - name: sd_type
        type: string
        nullable: true
        comment: School district type (elementary, secondary, or unified)
      - <<: *land_area_column
      - <<: *water_area_column
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [sd_lea, year]
      foreignKeys:
        - columns: [state_fips]
          targetTable: states
          targetColumns: [state_fips]

    dimensions:
      type:
        - boundary
      year: *tiger_year_range
      state_fips: *all_state_fips

    # TIGER tables use TigerDataProvider for binary shapefile handling
    source:
      type: http
      url: "https://www2.census.gov/geo/tiger/TIGER{year}/UNSD/tl_{year}_{state_fips}_unsd.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.TigerDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=boundary/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: school_districts
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # State Legislative Districts - Lower Chamber
  # --------------------------------------------------------------------------
  - name: state_legislative_lower
    pattern: "type=boundary/year=*/state_legislative_lower.parquet"
    comment: >
      State legislative district boundaries for lower chambers (State House/Assembly).
      Used for political analysis and representation mapping.

    columns:
      - name: sldl_fips
        type: string
        nullable: false
        comment: State legislative district lower chamber code (state + district)
      - <<: *state_fips_column
      - name: district_name
        type: string
        nullable: true
        comment: District name or number
      - <<: *land_area_column
      - <<: *water_area_column
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [sldl_fips, year]
      foreignKeys:
        - columns: [state_fips]
          targetTable: states
          targetColumns: [state_fips]

    dimensions:
      type:
        - boundary
      year: *tiger_year_range
      # Use custom resolver to exclude DC (11) and Nebraska (31) which don't have lower chambers
      state_fips:
        type: custom

    source:
      type: http
      url: "https://www2.census.gov/geo/tiger/TIGER{year}/SLDL/tl_{year}_{state_fips}_sldl.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.TigerDataProvider"
      dimensionResolver: "org.apache.calcite.adapter.govdata.geo.TigerStateLegislativeLowerDimensionResolver"

    materialize:
      format: iceberg
      output:
        pattern: "type=boundary/year=*/state_fips=*/"
      partition:
        columns: [type, year, state_fips]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: state_legislative_lower
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # State Legislative Districts - Upper Chamber
  # --------------------------------------------------------------------------
  - name: state_legislative_upper
    pattern: "type=boundary/year=*/state_legislative_upper.parquet"
    comment: >
      State legislative district boundaries for upper chambers (State Senate).
      Used for political analysis and representation mapping.

    columns:
      - name: sldu_fips
        type: string
        nullable: false
        comment: State legislative district upper chamber code (state + district)
      - <<: *state_fips_column
      - name: district_name
        type: string
        nullable: true
        comment: District name or number
      - <<: *land_area_column
      - <<: *water_area_column
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [sldu_fips, year]
      foreignKeys:
        - columns: [state_fips]
          targetTable: states
          targetColumns: [state_fips]

    dimensions:
      type:
        - boundary
      year: *tiger_year_range
      state_fips: *all_state_fips

    source:
      type: http
      url: "https://www2.census.gov/geo/tiger/TIGER{year}/SLDU/tl_{year}_{state_fips}_sldu.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.TigerDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=boundary/year=*/state_fips=*/"
      partition:
        columns: [type, year, state_fips]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: state_legislative_upper
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # County Subdivisions (Minor Civil Divisions)
  # --------------------------------------------------------------------------
  - name: county_subdivisions
    pattern: "type=boundary/year=*/county_subdivisions.parquet"
    comment: >
      County subdivisions including Minor Civil Divisions (MCDs), census county divisions,
      and unorganized territories. Represents administrative or statistical subdivisions
      of counties.

    columns:
      - name: cousub_fips
        type: string
        nullable: false
        comment: County subdivision FIPS code (state + county + subdivision)
      - <<: *state_fips_column
      - <<: *county_fips_column
      - name: cousub_name
        type: string
        nullable: true
        comment: County subdivision name
      - name: cousub_type
        type: string
        nullable: true
        comment: Legal/statistical area description code
      - <<: *land_area_column
      - <<: *water_area_column
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [cousub_fips, year]
      foreignKeys:
        - columns: [county_fips]
          targetTable: counties
          targetColumns: [county_fips]

    dimensions:
      type:
        - boundary
      year: *tiger_year_range
      state_fips: *all_state_fips

    source:
      type: http
      url: "https://www2.census.gov/geo/tiger/TIGER{year}/COUSUB/tl_{year}_{state_fips}_cousub.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.TigerDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=boundary/year=*/state_fips=*/"
      partition:
        columns: [type, year, state_fips]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: county_subdivisions
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # American Indian/Alaska Native/Native Hawaiian Areas
  # --------------------------------------------------------------------------
  - name: tribal_areas
    pattern: "type=boundary/year=*/tribal_areas.parquet"
    comment: >
      American Indian reservations, Alaska Native villages, and Native Hawaiian home lands.
      Includes federal and state recognized tribal boundaries and trust lands.

    columns:
      - name: aiannhce
        type: string
        nullable: false
        comment: American Indian/Alaska Native/Native Hawaiian area code
      - name: name
        type: string
        nullable: true
        comment: Area name
      - name: namelsad
        type: string
        nullable: true
        comment: Name and legal/statistical area description
      - name: area_type
        type: string
        nullable: true
        comment: Area type (federal reservation, state reservation, TDSA, etc.)
      - <<: *land_area_column
      - <<: *water_area_column
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [aiannhce, year]

    dimensions:
      type:
        - boundary
      year: *tiger_year_range

    source:
      type: http
      url: "https://www2.census.gov/geo/tiger/TIGER{year}/AIANNH/tl_{year}_us_aiannh.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.TigerDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=boundary/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: tribal_areas
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # Urban Areas
  # --------------------------------------------------------------------------
  - name: urban_areas
    pattern: "type=boundary/year=*/urban_areas.parquet"
    comment: >
      Census Bureau urban area boundaries. For 2020 Census, minimum threshold is 5,000
      people or 2,000 housing units. The distinction between Urbanized Areas and Urban
      Clusters was eliminated - all qualifying areas are now simply 'urban areas'.

    columns:
      - name: uace
        type: string
        nullable: false
        comment: Urban area code
      - name: name
        type: string
        nullable: true
        comment: Urban area name
      - name: urban_type
        type: string
        nullable: true
        comment: Urban type code (legacy field from pre-2020 Census, may be blank for 2020+ data)
      - <<: *land_area_column
      - <<: *water_area_column
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [uace, year]

    dimensions:
      type:
        - boundary
      year: *tiger_year_range

    source:
      type: http
      url: "https://www2.census.gov/geo/tiger/TIGER{year}/UAC/tl_{year}_us_uac20.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.TigerDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=boundary/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: urban_areas
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # Public Use Microdata Areas (PUMAs)
  # --------------------------------------------------------------------------
  - name: pumas
    pattern: "type=boundary/year=*/pumas.parquet"
    comment: >
      Public Use Microdata Areas for Census microdata products. Each PUMA contains
      at least 100,000 people and is built from census tracts and counties.

    columns:
      - name: puma_code
        type: string
        nullable: false
        comment: 5-digit PUMA code (unique within state)
      - <<: *state_fips_column
      - name: puma_name
        type: string
        nullable: true
        comment: PUMA name
      - <<: *land_area_column
      - <<: *water_area_column
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [state_fips, puma_code, year]
      foreignKeys:
        - columns: [state_fips]
          targetTable: states
          targetColumns: [state_fips]

    dimensions:
      type:
        - boundary
      year: *tiger_year_range
      state_fips: *all_state_fips

    source:
      type: http
      url: "https://www2.census.gov/geo/tiger/TIGER{year}/PUMA20/tl_{year}_{state_fips}_puma20.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.TigerDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=boundary/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: pumas
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # Voting Districts (VTDs)
  # --------------------------------------------------------------------------
  # VTD data is available for census years with different URL patterns:
  # - 2012: TIGER2012/VTD/tl_2012_{state}_vtd10.zip (2010 census boundaries)
  # - 2020: TIGER2020PL/LAYER/VTD/2020/tl_2020_{state}_vtd20.zip (2020 census boundaries)
  # TigerDataProvider handles the URL pattern differences automatically.
  - name: voting_districts
    pattern: "type=boundary/year=*/voting_districts.parquet"
    comment: >
      Voting district boundaries (precincts, wards, election districts) as reported
      by states for redistricting. Available for 2012 (2010 census vintage) and
      2020 (2020 census vintage). Attributes are normalized to canonical form.

    columns:
      - name: vtd_code
        type: string
        nullable: false
        comment: Voting district code (state + county + VTD)
      - <<: *state_fips_column
      - <<: *county_fips_column
      - name: vtd_name
        type: string
        nullable: true
        comment: Voting district name
      - <<: *land_area_column
      - <<: *water_area_column
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [vtd_code, year]
      foreignKeys:
        - columns: [county_fips]
          targetTable: counties
          targetColumns: [county_fips]

    dimensions:
      type:
        - boundary
      # VTD available for 2012 (2010 census) and 2020 (2020 census)
      # Using explicit list since years are not contiguous
      year:
        - "2012"
        - "2020"
      # Use resolver to filter states based on year - some states only have county-level files for 2020
      state_fips:
        type: custom

    source:
      type: http
      # URL pattern varies by year - TigerDataProvider handles this
      url: "https://www2.census.gov/geo/tiger/TIGER{year}/VTD/tl_{year}_{state_fips}_vtd.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.TigerDataProvider"
      dimensionResolver: "org.apache.calcite.adapter.govdata.geo.TigerVtdDimensionResolver"

    materialize:
      format: iceberg
      output:
        pattern: "type=boundary/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: voting_districts
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

# ============================================================================
# HUD CROSSWALK TABLES
# ============================================================================

  # --------------------------------------------------------------------------
  # ZIP to County Crosswalk
  # --------------------------------------------------------------------------
  - name: zip_county_crosswalk
    pattern: "type=crosswalk/year=*/zip_county_crosswalk.parquet"
    comment: >
      ZIP Code to County crosswalk file mapping ZIP codes to counties with residential
      and business address ratios. Source: HUD USPS ZIP Code Crosswalk.

    columns:
      - name: zip
        type: string
        nullable: false
        comment: 5-digit ZIP Code
      - <<: *county_fips_column
      - name: res_ratio
        type: double
        nullable: true
        comment: Ratio of residential addresses in this ZIP that are in this county
      - name: bus_ratio
        type: double
        nullable: true
        comment: Ratio of business addresses in this ZIP that are in this county
      - name: oth_ratio
        type: double
        nullable: true
        comment: Ratio of other addresses in this ZIP that are in this county
      - name: tot_ratio
        type: double
        nullable: true
        comment: Ratio of total addresses in this ZIP that are in this county

    partitions: *crosswalk_partitions

    constraints:
      primaryKey: [zip, county_fips, year]
      foreignKeys:
        - columns: [county_fips]
          targetTable: counties
          targetColumns: [county_fips]
      indexes:
        - [zip]
        - [county_fips]

    dimensions:
      type:
        - crosswalk
      year: *hud_year_range

    source:
      type: http
      url: "https://www.huduser.gov/hudapi/public/usps?type=2&year={year}&quarter=4&query=All"
      method: GET
      response:
        format: json
      headers:
        Authorization: "Bearer {env:HUD_TOKEN}"
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.HudCrosswalkTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=crosswalk/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: zip_county_crosswalk
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # ZIP to CBSA Crosswalk
  # --------------------------------------------------------------------------
  - name: zip_cbsa_crosswalk
    pattern: "type=crosswalk/year=*/zip_cbsa_crosswalk.parquet"
    comment: >
      ZIP Code to Core Based Statistical Area crosswalk mapping ZIP codes to
      metropolitan and micropolitan areas.

    columns:
      - name: zip
        type: string
        nullable: false
        comment: 5-digit ZIP Code
      - name: cbsa_code
        type: string
        nullable: false
        comment: 5-digit CBSA code for Core Based Statistical Area
      - name: res_ratio
        type: double
        nullable: true
        comment: Ratio of residential addresses in this ZIP that are in this CBSA
      - name: bus_ratio
        type: double
        nullable: true
        comment: Ratio of business addresses in this ZIP that are in this CBSA
      - name: oth_ratio
        type: double
        nullable: true
        comment: Ratio of other addresses in this ZIP that are in this CBSA
      - name: tot_ratio
        type: double
        nullable: true
        comment: Ratio of total addresses in this ZIP that are in this CBSA

    partitions: *crosswalk_partitions

    constraints:
      primaryKey: [zip, cbsa_code, year]
      foreignKeys:
        - columns: [cbsa_code]
          targetTable: cbsa
          targetColumns: [cbsa_fips]
      indexes:
        - [zip]
        - [cbsa_code]

    dimensions:
      type:
        - crosswalk
      year: *hud_year_range

    source:
      type: http
      url: "https://www.huduser.gov/hudapi/public/usps?type=3&year={year}&quarter=4&query=All"
      method: GET
      response:
        format: json
      headers:
        Authorization: "Bearer {env:HUD_TOKEN}"
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.HudCrosswalkTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=crosswalk/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: zip_cbsa_crosswalk
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # Tract to ZIP Crosswalk
  # --------------------------------------------------------------------------
  - name: tract_zip_crosswalk
    pattern: "type=crosswalk/year=*/tract_zip_crosswalk.parquet"
    comment: >
      Census tract to ZIP Code crosswalk for relating census geography to postal
      geography. Includes residential and business address ratios.

    columns:
      - name: tract_fips
        type: string
        nullable: false
        comment: 11-digit census tract FIPS code
      - name: zip
        type: string
        nullable: false
        comment: 5-digit ZIP Code
      - name: res_ratio
        type: double
        nullable: true
        comment: Ratio of residential addresses in this tract that are in this ZIP
      - name: bus_ratio
        type: double
        nullable: true
        comment: Ratio of business addresses in this tract that are in this ZIP
      - name: oth_ratio
        type: double
        nullable: true
        comment: Ratio of other addresses in this tract that are in this ZIP
      - name: tot_ratio
        type: double
        nullable: true
        comment: Ratio of total addresses in this tract that are in this ZIP

    partitions: *crosswalk_partitions

    constraints:
      primaryKey: [tract_fips, zip, year]
      foreignKeys:
        - columns: [tract_fips]
          targetTable: census_tracts
          targetColumns: [tract_fips]
      indexes:
        - [tract_fips]
        - [zip]

    dimensions:
      type:
        - crosswalk
      year: *hud_year_range

    source:
      type: http
      url: "https://www.huduser.gov/hudapi/public/usps?type=6&year={year}&quarter=4&query=All"
      method: GET
      response:
        format: json
      headers:
        Authorization: "Bearer {env:HUD_TOKEN}"
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.HudCrosswalkTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=crosswalk/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: tract_zip_crosswalk
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # ZIP to Tract Crosswalk
  # --------------------------------------------------------------------------
  - name: zip_tract_crosswalk
    pattern: "type=crosswalk/year=*/zip_tract_crosswalk.parquet"
    comment: >
      ZIP Code to Census Tract crosswalk mapping ZIP codes to census tracts
      with residential and business address ratios. Source: HUD USPS ZIP Code Crosswalk.

    columns:
      - name: zip
        type: string
        nullable: false
        comment: 5-digit ZIP Code
      - name: tract_fips
        type: string
        nullable: false
        comment: 11-digit census tract FIPS code
      - <<: *state_fips_column
      - name: res_ratio
        type: double
        nullable: true
        comment: Ratio of residential addresses in this ZIP that are in this tract
      - name: bus_ratio
        type: double
        nullable: true
        comment: Ratio of business addresses in this ZIP that are in this tract
      - name: oth_ratio
        type: double
        nullable: true
        comment: Ratio of other addresses in this ZIP that are in this tract
      - name: tot_ratio
        type: double
        nullable: true
        comment: Ratio of total addresses in this ZIP that are in this tract

    partitions: *crosswalk_partitions

    constraints:
      primaryKey: [zip, tract_fips, year]
      foreignKeys:
        - columns: [tract_fips]
          targetTable: census_tracts
          targetColumns: [tract_fips]
      indexes:
        - [zip]
        - [tract_fips]

    dimensions:
      type:
        - crosswalk
      year: *hud_year_range

    source:
      type: http
      url: "https://www.huduser.gov/hudapi/public/usps?type=1&year={year}&quarter=4&query=All"
      method: GET
      response:
        format: json
      headers:
        Authorization: "Bearer {env:HUD_TOKEN}"
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.HudCrosswalkTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=crosswalk/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: zip_tract_crosswalk
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # ZIP to Congressional District Crosswalk
  # --------------------------------------------------------------------------
  - name: zip_cd_crosswalk
    pattern: "type=crosswalk/year=*/zip_cd_crosswalk.parquet"
    comment: >
      ZIP Code to Congressional District crosswalk mapping ZIP codes to congressional
      districts with address ratios. Source: HUD USPS ZIP Code Crosswalk.

    columns:
      - name: zip
        type: string
        nullable: false
        comment: 5-digit ZIP Code
      - name: cd_fips
        type: string
        nullable: false
        comment: Congressional district code (state + district number)
      - name: res_ratio
        type: double
        nullable: true
        comment: Ratio of residential addresses in this ZIP that are in this CD
      - name: bus_ratio
        type: double
        nullable: true
        comment: Ratio of business addresses in this ZIP that are in this CD
      - name: oth_ratio
        type: double
        nullable: true
        comment: Ratio of other addresses in this ZIP that are in this CD
      - name: tot_ratio
        type: double
        nullable: true
        comment: Ratio of total addresses in this ZIP that are in this CD

    partitions: *crosswalk_partitions

    constraints:
      primaryKey: [zip, cd_fips, year]
      foreignKeys:
        - columns: [cd_fips]
          targetTable: congressional_districts
          targetColumns: [cd_fips]
      indexes:
        - [zip]
        - [cd_fips]

    dimensions:
      type:
        - crosswalk
      year: *hud_year_range

    source:
      type: http
      url: "https://www.huduser.gov/hudapi/public/usps?type=5&year={year}&quarter=4&query=All"
      method: GET
      response:
        format: json
      headers:
        Authorization: "Bearer {env:HUD_TOKEN}"
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.HudCrosswalkTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=crosswalk/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: zip_cd_crosswalk
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # County to ZIP Crosswalk (Reverse)
  # --------------------------------------------------------------------------
  - name: county_zip_crosswalk
    pattern: "type=crosswalk/year=*/county_zip_crosswalk.parquet"
    comment: >
      County to ZIP Code crosswalk for allocating county-level data to ZIP codes.
      Reverse mapping of zip_county_crosswalk. Source: HUD USPS ZIP Code Crosswalk.

    columns:
      - <<: *county_fips_column
      - name: zip
        type: string
        nullable: false
        comment: 5-digit ZIP Code
      - name: res_ratio
        type: double
        nullable: true
        comment: Ratio of residential addresses in this county that are in this ZIP
      - name: bus_ratio
        type: double
        nullable: true
        comment: Ratio of business addresses in this county that are in this ZIP
      - name: oth_ratio
        type: double
        nullable: true
        comment: Ratio of other addresses in this county that are in this ZIP
      - name: tot_ratio
        type: double
        nullable: true
        comment: Ratio of total addresses in this county that are in this ZIP

    partitions: *crosswalk_partitions

    constraints:
      primaryKey: [county_fips, zip, year]
      foreignKeys:
        - columns: [county_fips]
          targetTable: counties
          targetColumns: [county_fips]
      indexes:
        - [county_fips]
        - [zip]

    dimensions:
      type:
        - crosswalk
      year: *hud_year_range

    source:
      type: http
      url: "https://www.huduser.gov/hudapi/public/usps?type=7&year={year}&quarter=4&query=All"
      method: GET
      response:
        format: json
      headers:
        Authorization: "Bearer {env:HUD_TOKEN}"
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.HudCrosswalkTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=crosswalk/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: county_zip_crosswalk
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # Congressional District to ZIP Crosswalk (Reverse)
  # --------------------------------------------------------------------------
  - name: cd_zip_crosswalk
    pattern: "type=crosswalk/year=*/cd_zip_crosswalk.parquet"
    comment: >
      Congressional District to ZIP Code crosswalk for allocating district-level
      data to ZIP codes. Reverse mapping of zip_cd_crosswalk. Source: HUD USPS Crosswalk.

    columns:
      - name: cd_fips
        type: string
        nullable: false
        comment: Congressional district code (state + district number)
      - name: zip
        type: string
        nullable: false
        comment: 5-digit ZIP Code
      - name: res_ratio
        type: double
        nullable: true
        comment: Ratio of residential addresses in this CD that are in this ZIP
      - name: bus_ratio
        type: double
        nullable: true
        comment: Ratio of business addresses in this CD that are in this ZIP
      - name: oth_ratio
        type: double
        nullable: true
        comment: Ratio of other addresses in this CD that are in this ZIP
      - name: tot_ratio
        type: double
        nullable: true
        comment: Ratio of total addresses in this CD that are in this ZIP

    partitions: *crosswalk_partitions

    constraints:
      primaryKey: [cd_fips, zip, year]
      foreignKeys:
        - columns: [cd_fips]
          targetTable: congressional_districts
          targetColumns: [cd_fips]
      indexes:
        - [cd_fips]
        - [zip]

    dimensions:
      type:
        - crosswalk
      year: *hud_year_range

    source:
      type: http
      url: "https://www.huduser.gov/hudapi/public/usps?type=10&year={year}&quarter=4&query=All"
      method: GET
      response:
        format: json
      headers:
        Authorization: "Bearer {env:HUD_TOKEN}"
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.HudCrosswalkTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=crosswalk/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: cd_zip_crosswalk
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

# ============================================================================
# USDA RURAL-URBAN CLASSIFICATION TABLES
# ============================================================================

  # --------------------------------------------------------------------------
  # Rural-Urban Continuum Codes (County-level)
  # --------------------------------------------------------------------------
  - name: rural_urban_continuum
    pattern: "type=classification/year=*/rural_urban_continuum.parquet"
    comment: >
      USDA Economic Research Service Rural-Urban Continuum Codes classifying counties
      by degree of urbanization and adjacency to metro areas. 9-category classification
      updated decennially.

    columns:
      - <<: *county_fips_column
      - <<: *state_fips_column
      - name: county_name
        type: string
        nullable: true
        comment: County name
      - name: rucc_code
        type: int
        nullable: false
        comment: Rural-Urban Continuum Code (1-9)
      - name: rucc_description
        type: string
        nullable: true
        comment: Description of the RUCC category
      - name: population
        type: int
        nullable: true
        comment: County population from Census
      - name: metro_nonmetro
        type: string
        nullable: true
        comment: Metro (1-3) or Nonmetro (4-9) designation

    partitions: *crosswalk_partitions

    constraints:
      primaryKey: [county_fips, year]
      foreignKeys:
        - columns: [county_fips]
          targetTable: counties
          targetColumns: [county_fips]
      indexes:
        - [rucc_code]
        - [metro_nonmetro]

    dimensions:
      type:
        - classification
      year:
        type: yearRange
        start: "2023"
        lagYears: 0

    source:
      type: http
      url: "https://www.ers.usda.gov/media/5768/2023-rural-urban-continuum-codes.csv"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.UsdaDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=classification/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: rural_urban_continuum
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # RUCA Codes (Census Tract-level)
  # --------------------------------------------------------------------------
  - name: ruca_codes
    pattern: "type=classification/year=*/ruca_codes.parquet"
    comment: >
      USDA Rural-Urban Commuting Area codes at census tract level. More granular
      than county-level RUCC, based on population density and commuting patterns.
      Primary codes (1-10) with secondary subdivision codes.

    columns:
      - name: tract_fips
        type: string
        nullable: false
        comment: 11-digit census tract FIPS code
      - <<: *state_fips_column
      - <<: *county_fips_column
      - name: ruca_primary
        type: int
        nullable: false
        comment: Primary RUCA code (1-10)
      - name: ruca_secondary
        type: double
        nullable: true
        comment: Secondary RUCA code for subdivision
      - name: ruca_description
        type: string
        nullable: true
        comment: Description of the RUCA category
      - name: population
        type: int
        nullable: true
        comment: Tract population from Census

    partitions: *crosswalk_partitions

    constraints:
      primaryKey: [tract_fips, year]
      foreignKeys:
        - columns: [tract_fips]
          targetTable: census_tracts
          targetColumns: [tract_fips]
      indexes:
        - [ruca_primary]
        - [county_fips]

    dimensions:
      type:
        - classification
      year:
        type: yearRange
        start: "2023"
        lagYears: 0

    source:
      type: http
      url: "https://www.ers.usda.gov/media/5443/2020-rural-urban-commuting-area-codes-census-tracts.csv"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.UsdaDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=classification/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: ruca_codes
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

# ============================================================================
# CENSUS GAZETTEER REFERENCE TABLES
# ============================================================================

  # --------------------------------------------------------------------------
  # Gazetteer - Counties
  # --------------------------------------------------------------------------
  - name: gazetteer_counties
    pattern: "type=gazetteer/year=*/gazetteer_counties.parquet"
    comment: >
      Census Bureau Gazetteer file for counties with authoritative names, codes,
      area measurements, and representative coordinates. Official reference for
      county identifiers and centroids.

    columns:
      - <<: *county_fips_column
      - <<: *state_fips_column
      - name: county_name
        type: string
        nullable: false
        comment: Official county name
      - name: land_area_sqmi
        type: double
        nullable: true
        comment: Land area in square miles
      - name: water_area_sqmi
        type: double
        nullable: true
        comment: Water area in square miles
      - name: latitude
        type: double
        nullable: true
        comment: Internal point latitude (centroid)
      - name: longitude
        type: double
        nullable: true
        comment: Internal point longitude (centroid)

    partitions: *crosswalk_partitions

    constraints:
      primaryKey: [county_fips, year]
      indexes:
        - [state_fips]
        - [county_name]

    dimensions:
      type:
        - gazetteer
      year: *tiger_year_range

    source:
      type: http
      url: "https://www2.census.gov/geo/docs/maps-data/data/gazetteer/{year}_Gazetteer/{year}_Gaz_counties_national.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.GazetteerDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=gazetteer/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: gazetteer_counties
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # Gazetteer - Places
  # --------------------------------------------------------------------------
  - name: gazetteer_places
    pattern: "type=gazetteer/year=*/gazetteer_places.parquet"
    comment: >
      Census Bureau Gazetteer file for incorporated places and CDPs with authoritative
      names, codes, area measurements, and representative coordinates.

    columns:
      - name: place_fips
        type: string
        nullable: false
        comment: Place FIPS code (state + place)
      - <<: *state_fips_column
      - name: place_name
        type: string
        nullable: false
        comment: Official place name
      - name: place_type
        type: string
        nullable: true
        comment: Place type (city, town, CDP, etc.)
      - name: land_area_sqmi
        type: double
        nullable: true
        comment: Land area in square miles
      - name: water_area_sqmi
        type: double
        nullable: true
        comment: Water area in square miles
      - name: latitude
        type: double
        nullable: true
        comment: Internal point latitude (centroid)
      - name: longitude
        type: double
        nullable: true
        comment: Internal point longitude (centroid)
      - name: population
        type: int
        nullable: true
        comment: Population estimate
      - name: housing_units
        type: int
        nullable: true
        comment: Housing unit count

    partitions: *crosswalk_partitions

    constraints:
      primaryKey: [place_fips, year]
      indexes:
        - [state_fips]
        - [place_name]

    dimensions:
      type:
        - gazetteer
      year: *tiger_year_range

    source:
      type: http
      url: "https://www2.census.gov/geo/docs/maps-data/data/gazetteer/{year}_Gazetteer/{year}_Gaz_place_national.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.GazetteerDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=gazetteer/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: gazetteer_places
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # Gazetteer - ZCTAs
  # --------------------------------------------------------------------------
  - name: gazetteer_zctas
    pattern: "type=gazetteer/year=*/gazetteer_zctas.parquet"
    comment: >
      Census Bureau Gazetteer file for ZIP Code Tabulation Areas with area
      measurements and representative coordinates.

    columns:
      - name: zcta
        type: string
        nullable: false
        comment: 5-digit ZCTA code
      - name: land_area_sqmi
        type: double
        nullable: true
        comment: Land area in square miles
      - name: water_area_sqmi
        type: double
        nullable: true
        comment: Water area in square miles
      - name: latitude
        type: double
        nullable: true
        comment: Internal point latitude (centroid)
      - name: longitude
        type: double
        nullable: true
        comment: Internal point longitude (centroid)
      - name: population
        type: int
        nullable: true
        comment: Population estimate
      - name: housing_units
        type: int
        nullable: true
        comment: Housing unit count

    partitions: *crosswalk_partitions

    constraints:
      primaryKey: [zcta, year]
      indexes:
        - [zcta]

    dimensions:
      type:
        - gazetteer
      year: *tiger_year_range

    source:
      type: http
      url: "https://www2.census.gov/geo/docs/maps-data/data/gazetteer/{year}_Gazetteer/{year}_Gaz_zcta_national.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.GazetteerDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=gazetteer/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: gazetteer_zctas
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

# ============================================================================
# USGS WATERSHED BOUNDARY TABLES
# ============================================================================

  # --------------------------------------------------------------------------
  # Watersheds - HUC2 (Regions)
  # --------------------------------------------------------------------------
  - name: watersheds_huc2
    pattern: "type=watershed/year=*/watersheds_huc2.parquet"
    comment: >
      USGS Watershed Boundary Dataset HUC2 regions - the largest hydrologic units
      dividing the country into 22 major drainage basins.

    columns:
      - name: huc2
        type: string
        nullable: false
        comment: 2-digit Hydrologic Unit Code
      - name: name
        type: string
        nullable: true
        comment: Watershed region name
      - name: area_sq_km
        type: double
        nullable: true
        comment: Total area in square kilometers
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [huc2, year]

    dimensions:
      type:
        - watershed
      year: *tiger_year_range

    source:
      type: http
      url: "https://prd-tnm.s3.amazonaws.com/StagedProducts/Hydrography/WBD/National/GDB/WBD_National_GDB.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.WatershedDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=watershed/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: watersheds_huc2
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # Watersheds - HUC4 (Subregions)
  # --------------------------------------------------------------------------
  - name: watersheds_huc4
    pattern: "type=watershed/year=*/watersheds_huc4.parquet"
    comment: >
      USGS Watershed Boundary Dataset HUC4 subregions - subdivisions of HUC2
      regions into approximately 223 subregions.

    columns:
      - name: huc4
        type: string
        nullable: false
        comment: 4-digit Hydrologic Unit Code
      - name: huc2
        type: string
        nullable: false
        comment: Parent HUC2 region code
      - name: name
        type: string
        nullable: true
        comment: Watershed subregion name
      - name: area_sq_km
        type: double
        nullable: true
        comment: Total area in square kilometers
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [huc4, year]
      foreignKeys:
        - columns: [huc2]
          targetTable: watersheds_huc2
          targetColumns: [huc2]

    dimensions:
      type:
        - watershed
      year: *tiger_year_range

    source:
      type: http
      url: "https://prd-tnm.s3.amazonaws.com/StagedProducts/Hydrography/WBD/National/GDB/WBD_National_GDB.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.WatershedDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=watershed/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: watersheds_huc4
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # Watersheds - HUC8 (Subbasins)
  # --------------------------------------------------------------------------
  - name: watersheds_huc8
    pattern: "type=watershed/year=*/watersheds_huc8.parquet"
    comment: >
      USGS Watershed Boundary Dataset HUC8 subbasins - commonly used watershed
      level for water quality and resource management with ~2,300 units.

    columns:
      - name: huc8
        type: string
        nullable: false
        comment: 8-digit Hydrologic Unit Code
      - name: huc4
        type: string
        nullable: false
        comment: Parent HUC4 subregion code
      - name: name
        type: string
        nullable: true
        comment: Watershed subbasin name
      - name: area_sq_km
        type: double
        nullable: true
        comment: Total area in square kilometers
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [huc8, year]
      foreignKeys:
        - columns: [huc4]
          targetTable: watersheds_huc4
          targetColumns: [huc4]

    dimensions:
      type:
        - watershed
      year: *tiger_year_range

    source:
      type: http
      url: "https://prd-tnm.s3.amazonaws.com/StagedProducts/Hydrography/WBD/National/GDB/WBD_National_GDB.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.WatershedDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=watershed/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: watersheds_huc8
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760

  # --------------------------------------------------------------------------
  # Watersheds - HUC12 (Subwatersheds)
  # --------------------------------------------------------------------------
  - name: watersheds_huc12
    pattern: "type=watershed/year=*/watersheds_huc12.parquet"
    comment: >
      USGS Watershed Boundary Dataset HUC12 subwatersheds - the smallest standard
      hydrologic units with approximately 100,000 units nationally.

    columns:
      - name: huc12
        type: string
        nullable: false
        comment: 12-digit Hydrologic Unit Code
      - name: huc8
        type: string
        nullable: false
        comment: Parent HUC8 subbasin code
      - name: name
        type: string
        nullable: true
        comment: Subwatershed name
      - name: area_sq_km
        type: double
        nullable: true
        comment: Total area in square kilometers
      - <<: *geometry_column

    partitions: *boundary_partitions

    constraints:
      primaryKey: [huc12, year]
      foreignKeys:
        - columns: [huc8]
          targetTable: watersheds_huc8
          targetColumns: [huc8]

    dimensions:
      type:
        - watershed
      year: *tiger_year_range

    source:
      type: http
      url: "https://prd-tnm.s3.amazonaws.com/StagedProducts/Hydrography/WBD/National/GDB/WBD_National_GDB.zip"
      method: GET
      response:
        format: json

    hooks:
      dataProvider: "org.apache.calcite.adapter.govdata.geo.WatershedDataProvider"

    materialize:
      format: iceberg
      output:
        pattern: "type=watershed/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=geo/GEO"
        tableName: watersheds_huc12
        catalogType: hadoop
        runCompaction: true
        compactionTargetFileSizeBytes: 134217728
        compactionMinFiles: 5
        compactionSmallFileSizeBytes: 10485760
