# ============================================================================
# U.S. Census Bureau Data Schema
# ============================================================================
# Data Sources:
#   - American Community Survey (ACS) 5-year estimates
#   - Decennial Census (2010, 2020)
#   - Population Estimates Program (PEP)
#
# Features:
#   - Hive-style partitioning for efficient querying
#   - Rate-limited API integration
#   - Iceberg materialization support
# ============================================================================

schemaName: "${SCHEMA_NAME:census}"
dataLagYears: 1
materializeDirectory: "${GOVDATA_PARQUET_DIR}/source=census"

comment: >
  U.S. Census Bureau demographic and population data including American Community Survey (ACS)
  estimates, decennial census results, and population estimates. Provides comprehensive demographic
  profiles, household characteristics, income distributions, educational attainment, housing
  statistics, and migration patterns at national, state, and county levels.

# ============================================================================
# HOOKS CONFIGURATION
# ============================================================================
# Response transformer for Census API's 2D array format
# ============================================================================

hooks:
  responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

# ============================================================================
# COLUMN TEMPLATES
# ============================================================================
# Reusable column definitions using YAML anchors
# ============================================================================

column_templates:

  # --- Geographic Identifier Columns ---

  geoid_column: &geoid_column
    name: geoid
    type: string
    nullable: true
    comment: Geographic identifier (FIPS code)

  name_column: &name_column
    name: geo_name
    type: string
    nullable: true
    expression: 'src."NAME"'
    comment: Geographic area name

  state_column: &state_column
    name: state
    type: string
    nullable: true
    comment: State FIPS code (2 digits)

  county_column: &county_column
    name: county
    type: string
    nullable: true
    comment: County FIPS code (3 digits, within state)

  county_fips_column: &county_fips_column
    name: county_fips
    type: string
    nullable: true
    expression: "CASE WHEN county IS NOT NULL THEN state || county ELSE NULL END"
    comment: 5-digit county FIPS code (state + county) for joining to geo.counties

  # --- Partition Column Definitions ---

  partition_type: &partition_type
    name: type
    type: VARCHAR

  partition_year: &partition_year
    name: year
    type: INTEGER

  partition_geography: &partition_geography
    name: geography
    type: VARCHAR

  # --- Standard Partition Set ---

  standard_partitions: &standard_partitions
    style: hive
    columnDefinitions:
      - *partition_type
      - *partition_year
      - *partition_geography

# ============================================================================
# DIMENSION VALUES
# ============================================================================
# Reusable dimension value lists
# ============================================================================

dimension_values:

  # --- Year Range for ACS (starts 2009) ---
  # ACS 5-year estimates available from 2009 onwards
  # Override: CENSUS_START_YEAR for Census-only, GOVDATA_START_YEAR for all schemas
  # lagYears: 3 because ACS 5-year data is released ~2 years after the survey year
  acs_year_range: &acs_year_range
    type: yearRange
    start: "${CENSUS_START_YEAR:${GOVDATA_START_YEAR:2000}}"
    lagYears: 3

  # --- Year Values for Decennial Census ---
  decennial_years: &decennial_years
    - '2020'
    - '2010'
    - '2000'

  # --- Geography Levels ---
  state_geography: &state_geography
    - state

  county_geography: &county_geography
    - county

  all_geographies: &all_geographies
    - state
    - county

  # All 50 states + DC (FIPS 01-56, excluding 03, 07, 14, 43, 52)
  all_state_fips: &all_state_fips
    - '01'  # Alabama
    - '02'  # Alaska
    - '04'  # Arizona
    - '05'  # Arkansas
    - '06'  # California
    - '08'  # Colorado
    - '09'  # Connecticut
    - '10'  # Delaware
    - '11'  # District of Columbia
    - '12'  # Florida
    - '13'  # Georgia
    - '15'  # Hawaii
    - '16'  # Idaho
    - '17'  # Illinois
    - '18'  # Indiana
    - '19'  # Iowa
    - '20'  # Kansas
    - '21'  # Kentucky
    - '22'  # Louisiana
    - '23'  # Maine
    - '24'  # Maryland
    - '25'  # Massachusetts
    - '26'  # Michigan
    - '27'  # Minnesota
    - '28'  # Mississippi
    - '29'  # Missouri
    - '30'  # Montana
    - '31'  # Nebraska
    - '32'  # Nevada
    - '33'  # New Hampshire
    - '34'  # New Jersey
    - '35'  # New Mexico
    - '36'  # New York
    - '37'  # North Carolina
    - '38'  # North Dakota
    - '39'  # Ohio
    - '40'  # Oklahoma
    - '41'  # Oregon
    - '42'  # Pennsylvania
    - '44'  # Rhode Island
    - '45'  # South Carolina
    - '46'  # South Dakota
    - '47'  # Tennessee
    - '48'  # Texas
    - '49'  # Utah
    - '50'  # Vermont
    - '51'  # Virginia
    - '53'  # Washington
    - '54'  # West Virginia
    - '55'  # Wisconsin
    - '56'  # Wyoming

# ============================================================================
# MATERIALIZATION OPTIONS
# ============================================================================
# Default materialization settings for all tables
# ============================================================================

materializationDefaults:
  format: iceberg
  options:
    warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
    icebergTableName: "${TABLE_NAME}"
    catalogType: hadoop
    # Iceberg-specific options
    partitionBy:
      - type
      - year
      - geography
    # Self-healing for empty results (requery after 7 days)
    emptyResultTtlDays: 7
    # Error retry after 1 day
    errorTtlDays: 1

# ============================================================================
# PARTITIONED TABLES
# ============================================================================

partitionedTables:

  # ---------------------------------------------------------------------------
  # ACS POPULATION - Total population and demographics
  # ---------------------------------------------------------------------------
  - name: acs_population
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      American Community Survey population demographics including total population,
      age, sex, race, and ethnicity. Provides population counts at state and county levels.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      # Schema Evolution: Column expressions use conceptual names that are
      # normalized by CensusVariableNormalizer from API-specific variable codes
      # (e.g., B01001_001E for ACS, P1_001N for Decennial 2020)
      - name: total_population
        type: long
        nullable: true
        expression: 'TRY_CAST(src."total_population" AS BIGINT)'
        comment: Total population
      - name: male_population
        type: long
        nullable: true
        expression: 'TRY_CAST(src."male_population" AS BIGINT)'
        comment: Male population
      - name: female_population
        type: long
        nullable: true
        expression: 'TRY_CAST(src."female_population" AS BIGINT)'
        comment: Female population

    # HTTP Source configuration for EtlPipeline
    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B01001_001E,B01001_002E,B01001_026E&for={geography}:*"
      method: GET
      response:
        format: json
        # Census returns 2D array - CensusResponseTransformer handles conversion
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    # Custom hooks for Census response transformation and schema evolution
    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"
      variableNormalizer: "org.apache.calcite.adapter.file.etl.MappingFileVariableNormalizer"
      variableNormalizerConfig:
        mappingFile: "census/census-variable-mappings.json"
        defaultType: "acs"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_population
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS INCOME - Household income statistics
  # ---------------------------------------------------------------------------
  - name: acs_income
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Household and family income statistics from ACS including median household income
      and per capita income at state and county levels.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      # Schema Evolution: Uses canonical name from CensusVariableNormalizer
      - name: median_household_income
        type: long
        nullable: true
        expression: 'TRY_CAST(src."median_household_income" AS BIGINT)'
        comment: Median household income in the past 12 months
      - name: per_capita_income
        type: long
        nullable: true
        expression: 'TRY_CAST(src."per_capita_income" AS BIGINT)'
        comment: Per capita income in the past 12 months

    # HTTP Source configuration for EtlPipeline
    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B19013_001E,B19301_001E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    # Custom hooks for Census response transformation and schema evolution
    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"
      variableNormalizer: "org.apache.calcite.adapter.file.etl.MappingFileVariableNormalizer"
      variableNormalizerConfig:
        mappingFile: "census/census-variable-mappings.json"
        defaultType: "acs"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_income
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS HOUSING - Housing unit statistics
  # ---------------------------------------------------------------------------
  - name: acs_housing
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Housing characteristics from ACS including total housing units, occupancy status,
      median home value, and median rent.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      # Schema Evolution: Uses canonical names from CensusVariableNormalizer
      - name: total_housing_units
        type: long
        nullable: true
        expression: 'TRY_CAST(src."total_housing_units" AS BIGINT)'
        comment: Total housing units
      - name: occupied_units
        type: long
        nullable: true
        expression: 'TRY_CAST(src."occupied_housing_units" AS BIGINT)'
        comment: Occupied housing units
      - name: vacant_units
        type: long
        nullable: true
        expression: 'TRY_CAST(src."vacant_housing_units" AS BIGINT)'
        comment: Vacant housing units
      - name: median_home_value
        type: long
        nullable: true
        expression: 'TRY_CAST(src."median_home_value" AS BIGINT)'
        comment: Median value of owner-occupied housing units
      - name: median_rent
        type: long
        nullable: true
        expression: 'TRY_CAST(src."median_gross_rent" AS BIGINT)'
        comment: Median gross rent

    # HTTP Source configuration for EtlPipeline
    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B25001_001E,B25002_002E,B25002_003E,B25077_001E,B25064_001E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    # Custom hooks for Census response transformation and schema evolution
    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"
      variableNormalizer: "org.apache.calcite.adapter.file.etl.MappingFileVariableNormalizer"
      variableNormalizerConfig:
        mappingFile: "census/census-variable-mappings.json"
        defaultType: "acs"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_housing
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS EDUCATION - Educational attainment
  # ---------------------------------------------------------------------------
  - name: acs_education
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Educational attainment from ACS including high school graduation rates
      and bachelor's degree attainment for population 25 years and over.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      # Schema Evolution: Uses canonical names from CensusVariableNormalizer
      - name: pop_25_plus
        type: long
        nullable: true
        expression: 'TRY_CAST(src."population_25_and_over" AS BIGINT)'
        comment: Total population 25 years and over
      - name: hs_graduate
        type: long
        nullable: true
        expression: 'TRY_CAST(src."high_school_graduate" AS BIGINT)'
        comment: Regular high school diploma (excludes GED/equivalency)
      - name: bachelors
        type: long
        nullable: true
        expression: 'TRY_CAST(src."bachelor_degree" AS BIGINT)'
        comment: Bachelor's degree only (excludes higher degrees)
      - name: masters
        type: long
        nullable: true
        expression: 'TRY_CAST(src."masters_degree" AS BIGINT)'
        comment: Master's degree
      - name: doctorate
        type: long
        nullable: true
        expression: 'TRY_CAST(src."doctorate_degree" AS BIGINT)'
        comment: Doctorate degree

    # HTTP Source configuration for EtlPipeline
    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B15003_001E,B15003_017E,B15003_022E,B15003_023E,B15003_025E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    # Custom hooks for Census response transformation and schema evolution
    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"
      variableNormalizer: "org.apache.calcite.adapter.file.etl.MappingFileVariableNormalizer"
      variableNormalizerConfig:
        mappingFile: "census/census-variable-mappings.json"
        defaultType: "acs"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_education
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS EMPLOYMENT - Employment and labor force statistics
  # ---------------------------------------------------------------------------
  - name: acs_employment
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Employment status and labor force participation from ACS including
      employed, unemployed, and labor force participation rates.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      # Schema Evolution: Uses canonical names from CensusVariableNormalizer
      - name: labor_force
        type: long
        nullable: true
        expression: 'TRY_CAST(src."labor_force_participation" AS BIGINT)'
        comment: Civilian labor force (population 16 years and over)
      - name: employed
        type: long
        nullable: true
        expression: 'TRY_CAST(src."employed_population" AS BIGINT)'
        comment: Employed (civilian labor force)
      - name: unemployed
        type: long
        nullable: true
        expression: 'TRY_CAST(src."unemployed_population" AS BIGINT)'
        comment: Unemployed (civilian labor force)
      - name: not_in_labor_force
        type: long
        nullable: true
        expression: 'TRY_CAST(src."not_in_labor_force" AS BIGINT)'
        comment: Not in labor force

    # HTTP Source configuration for EtlPipeline
    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B23025_002E,B23025_004E,B23025_005E,B23025_007E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    # Custom hooks for Census response transformation and schema evolution
    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"
      variableNormalizer: "org.apache.calcite.adapter.file.etl.MappingFileVariableNormalizer"
      variableNormalizerConfig:
        mappingFile: "census/census-variable-mappings.json"
        defaultType: "acs"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_employment
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS POVERTY - Poverty statistics
  # ---------------------------------------------------------------------------
  - name: acs_poverty
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Poverty statistics from ACS including population below poverty level
      and poverty rates by demographic groups.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      # Schema Evolution: Uses canonical names from CensusVariableNormalizer
      - name: poverty_universe
        type: long
        nullable: true
        expression: 'TRY_CAST(src."total_population_poverty_determined" AS BIGINT)'
        comment: Population for whom poverty status is determined (excludes institutionalized, military, unrelated children under 15)
      - name: below_poverty
        type: long
        nullable: true
        expression: 'TRY_CAST(src."below_poverty_level" AS BIGINT)'
        comment: Income below poverty level in past 12 months

    # HTTP Source configuration for EtlPipeline
    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B17001_001E,B17001_002E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    # Custom hooks for Census response transformation and schema evolution
    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"
      variableNormalizer: "org.apache.calcite.adapter.file.etl.MappingFileVariableNormalizer"
      variableNormalizerConfig:
        mappingFile: "census/census-variable-mappings.json"
        defaultType: "acs"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_poverty
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # DECENNIAL POPULATION - Unified table for 2000, 2010, 2020
  # ---------------------------------------------------------------------------
  # Single table with conformed schema across all census years.
  # Uses CensusDecennialDimensionResolver to provide year-specific:
  #   - dataset: sf1 (2000/2010) vs pl (2020)
  #   - variables: P001001,... (2000/2010) vs P1_001N,... (2020)
  # CensusVariableNormalizer maps all variants to canonical column names.
  # ---------------------------------------------------------------------------
  - name: decennial_population
    pattern: "type=decennial/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Decennial Census population from 2000, 2010, and 2020. Unified schema
      across all years with columns normalized to canonical names regardless
      of year-specific API variable codes (P001001 vs P1_001N, etc.).

    dimensions:
      type:
        - decennial
      year: *decennial_years
      dataset:
        type: custom
      variables:
        type: custom
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      # Schema Evolution: CensusVariableNormalizer maps year-specific variables
      # (P001001/P1_001N) to canonical names (total_population)
      - name: total_population
        type: long
        nullable: true
        expression: 'TRY_CAST(src."total_population" AS BIGINT)'
        comment: Total population
      - name: white_alone
        type: long
        nullable: true
        expression: 'TRY_CAST(src."white_alone" AS BIGINT)'
        comment: Population identifying as White alone
      - name: black_alone
        type: long
        nullable: true
        expression: 'TRY_CAST(src."black_african_american_alone" AS BIGINT)'
        comment: Population identifying as Black or African American alone
      - name: asian_alone
        type: long
        nullable: true
        expression: 'TRY_CAST(src."asian_alone" AS BIGINT)'
        comment: Population identifying as Asian alone

    source:
      type: http
      # URL uses resolved {dataset} and {variables} based on year
      url: "https://api.census.gov/data/{year}/dec/{dataset}?get=NAME,{variables}&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"
      variableNormalizer: "org.apache.calcite.adapter.file.etl.MappingFileVariableNormalizer"
      variableNormalizerConfig:
        mappingFile: "census/census-variable-mappings.json"
        defaultType: "decennial"
      dimensionResolver: "org.apache.calcite.adapter.govdata.census.CensusDecennialDimensionResolver"

    materialize:
      format: iceberg
      output:
        pattern: "type=decennial/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: decennial_population
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS RACE & ETHNICITY - Detailed race and Hispanic origin breakdown
  # ---------------------------------------------------------------------------
  - name: acs_race_ethnicity
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Detailed race and Hispanic/Latino origin demographics from ACS including
      population counts by race categories and Hispanic origin status.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: white_alone
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B02001_002E" AS BIGINT)'
        comment: White alone
      - name: black_alone
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B02001_003E" AS BIGINT)'
        comment: Black or African American alone
      - name: american_indian_alone
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B02001_004E" AS BIGINT)'
        comment: American Indian and Alaska Native alone
      - name: asian_alone
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B02001_005E" AS BIGINT)'
        comment: Asian alone
      - name: pacific_islander_alone
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B02001_006E" AS BIGINT)'
        comment: Native Hawaiian and Other Pacific Islander alone
      - name: other_race_alone
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B02001_007E" AS BIGINT)'
        comment: Some other race alone
      - name: two_or_more_races
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B02001_008E" AS BIGINT)'
        comment: Two or more races
      - name: hispanic_latino
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B03003_003E" AS BIGINT)'
        comment: Hispanic or Latino origin (any race)
      - name: not_hispanic_latino
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B03003_002E" AS BIGINT)'
        comment: Not Hispanic or Latino

    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B02001_002E,B02001_003E,B02001_004E,B02001_005E,B02001_006E,B02001_007E,B02001_008E,B03003_002E,B03003_003E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_race_ethnicity
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS AGE - Age distribution and median age
  # ---------------------------------------------------------------------------
  - name: acs_age
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Age distribution from ACS including median age and population by age groups.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: median_age
        type: double
        nullable: true
        expression: 'TRY_CAST(src."B01002_001E" AS DOUBLE)'
        comment: Median age
      - name: under_5_years
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B01001_003E" AS BIGINT) + TRY_CAST(src."B01001_027E" AS BIGINT)'
        comment: Population under 5 years
      - name: age_5_to_17
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B01001_004E" AS BIGINT) + TRY_CAST(src."B01001_005E" AS BIGINT) + TRY_CAST(src."B01001_006E" AS BIGINT) + TRY_CAST(src."B01001_028E" AS BIGINT) + TRY_CAST(src."B01001_029E" AS BIGINT) + TRY_CAST(src."B01001_030E" AS BIGINT)'
        comment: Population 5 to 17 years (school age)
      - name: age_18_to_64
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B01001_007E" AS BIGINT) + TRY_CAST(src."B01001_008E" AS BIGINT) + TRY_CAST(src."B01001_009E" AS BIGINT) + TRY_CAST(src."B01001_010E" AS BIGINT) + TRY_CAST(src."B01001_011E" AS BIGINT) + TRY_CAST(src."B01001_012E" AS BIGINT) + TRY_CAST(src."B01001_013E" AS BIGINT) + TRY_CAST(src."B01001_014E" AS BIGINT) + TRY_CAST(src."B01001_015E" AS BIGINT) + TRY_CAST(src."B01001_016E" AS BIGINT) + TRY_CAST(src."B01001_017E" AS BIGINT) + TRY_CAST(src."B01001_018E" AS BIGINT) + TRY_CAST(src."B01001_019E" AS BIGINT) + TRY_CAST(src."B01001_031E" AS BIGINT) + TRY_CAST(src."B01001_032E" AS BIGINT) + TRY_CAST(src."B01001_033E" AS BIGINT) + TRY_CAST(src."B01001_034E" AS BIGINT) + TRY_CAST(src."B01001_035E" AS BIGINT) + TRY_CAST(src."B01001_036E" AS BIGINT) + TRY_CAST(src."B01001_037E" AS BIGINT) + TRY_CAST(src."B01001_038E" AS BIGINT) + TRY_CAST(src."B01001_039E" AS BIGINT) + TRY_CAST(src."B01001_040E" AS BIGINT) + TRY_CAST(src."B01001_041E" AS BIGINT) + TRY_CAST(src."B01001_042E" AS BIGINT) + TRY_CAST(src."B01001_043E" AS BIGINT)'
        comment: Working age population 18 to 64
      - name: age_65_and_over
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B01001_020E" AS BIGINT) + TRY_CAST(src."B01001_021E" AS BIGINT) + TRY_CAST(src."B01001_022E" AS BIGINT) + TRY_CAST(src."B01001_023E" AS BIGINT) + TRY_CAST(src."B01001_024E" AS BIGINT) + TRY_CAST(src."B01001_025E" AS BIGINT) + TRY_CAST(src."B01001_044E" AS BIGINT) + TRY_CAST(src."B01001_045E" AS BIGINT) + TRY_CAST(src."B01001_046E" AS BIGINT) + TRY_CAST(src."B01001_047E" AS BIGINT) + TRY_CAST(src."B01001_048E" AS BIGINT) + TRY_CAST(src."B01001_049E" AS BIGINT)'
        comment: Senior population 65 years and over

    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B01002_001E,B01001_003E,B01001_004E,B01001_005E,B01001_006E,B01001_007E,B01001_008E,B01001_009E,B01001_010E,B01001_011E,B01001_012E,B01001_013E,B01001_014E,B01001_015E,B01001_016E,B01001_017E,B01001_018E,B01001_019E,B01001_020E,B01001_021E,B01001_022E,B01001_023E,B01001_024E,B01001_025E,B01001_027E,B01001_028E,B01001_029E,B01001_030E,B01001_031E,B01001_032E,B01001_033E,B01001_034E,B01001_035E,B01001_036E,B01001_037E,B01001_038E,B01001_039E,B01001_040E,B01001_041E,B01001_042E,B01001_043E,B01001_044E,B01001_045E,B01001_046E,B01001_047E,B01001_048E,B01001_049E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_age
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS COMMUTING - Transportation to work patterns
  # ---------------------------------------------------------------------------
  - name: acs_commuting
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Commuting patterns from ACS including means of transportation to work,
      travel time, and work-from-home statistics.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: total_workers
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B08301_001E" AS BIGINT)'
        comment: Total workers 16 years and over
      - name: drove_alone
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B08301_003E" AS BIGINT)'
        comment: Workers who drove alone
      - name: carpooled
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B08301_004E" AS BIGINT)'
        comment: Workers who carpooled
      - name: public_transit
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B08301_010E" AS BIGINT)'
        comment: Workers using public transportation
      - name: walked
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B08301_019E" AS BIGINT)'
        comment: Workers who walked to work
      - name: bicycle
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B08301_018E" AS BIGINT)'
        comment: Workers who bicycled to work
      - name: worked_from_home
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B08301_021E" AS BIGINT)'
        comment: Workers who worked from home
      - name: mean_travel_time
        type: double
        nullable: true
        expression: 'TRY_CAST(src."B08135_001E" AS DOUBLE)'
        comment: Mean travel time to work (minutes)

    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B08301_001E,B08301_003E,B08301_004E,B08301_010E,B08301_018E,B08301_019E,B08301_021E,B08135_001E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_commuting
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS HEALTH INSURANCE - Health insurance coverage
  # ---------------------------------------------------------------------------
  - name: acs_health_insurance
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Health insurance coverage from ACS including coverage rates by age and type.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: total_population
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B27001_001E" AS BIGINT)'
        comment: Total civilian noninstitutionalized population
      - name: with_health_insurance
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B27001_004E" AS BIGINT) + TRY_CAST(src."B27001_007E" AS BIGINT) + TRY_CAST(src."B27001_010E" AS BIGINT) + TRY_CAST(src."B27001_013E" AS BIGINT) + TRY_CAST(src."B27001_016E" AS BIGINT) + TRY_CAST(src."B27001_019E" AS BIGINT) + TRY_CAST(src."B27001_022E" AS BIGINT) + TRY_CAST(src."B27001_025E" AS BIGINT) + TRY_CAST(src."B27001_028E" AS BIGINT) + TRY_CAST(src."B27001_032E" AS BIGINT) + TRY_CAST(src."B27001_035E" AS BIGINT) + TRY_CAST(src."B27001_038E" AS BIGINT) + TRY_CAST(src."B27001_041E" AS BIGINT) + TRY_CAST(src."B27001_044E" AS BIGINT) + TRY_CAST(src."B27001_047E" AS BIGINT) + TRY_CAST(src."B27001_050E" AS BIGINT) + TRY_CAST(src."B27001_053E" AS BIGINT) + TRY_CAST(src."B27001_056E" AS BIGINT)'
        comment: Population with health insurance coverage
      - name: no_health_insurance
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B27001_005E" AS BIGINT) + TRY_CAST(src."B27001_008E" AS BIGINT) + TRY_CAST(src."B27001_011E" AS BIGINT) + TRY_CAST(src."B27001_014E" AS BIGINT) + TRY_CAST(src."B27001_017E" AS BIGINT) + TRY_CAST(src."B27001_020E" AS BIGINT) + TRY_CAST(src."B27001_023E" AS BIGINT) + TRY_CAST(src."B27001_026E" AS BIGINT) + TRY_CAST(src."B27001_029E" AS BIGINT) + TRY_CAST(src."B27001_033E" AS BIGINT) + TRY_CAST(src."B27001_036E" AS BIGINT) + TRY_CAST(src."B27001_039E" AS BIGINT) + TRY_CAST(src."B27001_042E" AS BIGINT) + TRY_CAST(src."B27001_045E" AS BIGINT) + TRY_CAST(src."B27001_048E" AS BIGINT) + TRY_CAST(src."B27001_051E" AS BIGINT) + TRY_CAST(src."B27001_054E" AS BIGINT) + TRY_CAST(src."B27001_057E" AS BIGINT)'
        comment: Population without health insurance coverage
      - name: public_coverage
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B27003_004E" AS BIGINT)'
        comment: Population with public health insurance
      - name: private_coverage
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B27002_004E" AS BIGINT)'
        comment: Population with private health insurance

    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B27001_001E,B27001_004E,B27001_005E,B27001_007E,B27001_008E,B27001_010E,B27001_011E,B27001_013E,B27001_014E,B27001_016E,B27001_017E,B27001_019E,B27001_020E,B27001_022E,B27001_023E,B27001_025E,B27001_026E,B27001_028E,B27001_029E,B27001_032E,B27001_033E,B27001_035E,B27001_036E,B27001_038E,B27001_039E,B27001_041E,B27001_042E,B27001_044E,B27001_045E,B27001_047E,B27001_048E,B27001_050E,B27001_051E,B27001_053E,B27001_054E,B27001_056E,B27001_057E,B27002_004E,B27003_004E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_health_insurance
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS LANGUAGE - Language spoken at home
  # ---------------------------------------------------------------------------
  - name: acs_language
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Language spoken at home from ACS including English proficiency.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: population_5_plus
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B16001_001E" AS BIGINT)'
        comment: Population 5 years and over
      - name: english_only
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B16001_002E" AS BIGINT)'
        comment: Speak only English at home
      - name: spanish
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B16001_003E" AS BIGINT)'
        comment: Speak Spanish at home
      - name: spanish_limited_english
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B16001_005E" AS BIGINT)'
        comment: Speak Spanish, limited English proficiency
      - name: other_indo_european
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B16001_006E" AS BIGINT)'
        comment: Speak other Indo-European language
      - name: asian_pacific_languages
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B16001_009E" AS BIGINT)'
        comment: Speak Asian and Pacific Island languages
      - name: other_languages
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B16001_012E" AS BIGINT)'
        comment: Speak other languages

    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B16001_001E,B16001_002E,B16001_003E,B16001_005E,B16001_006E,B16001_009E,B16001_012E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_language
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS DISABILITY - Disability status
  # ---------------------------------------------------------------------------
  - name: acs_disability
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Disability status from ACS including types of disabilities.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: total_population
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B18101_001E" AS BIGINT)'
        comment: Total civilian noninstitutionalized population
      - name: with_disability
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B18101_004E" AS BIGINT) + TRY_CAST(src."B18101_007E" AS BIGINT) + TRY_CAST(src."B18101_010E" AS BIGINT) + TRY_CAST(src."B18101_013E" AS BIGINT) + TRY_CAST(src."B18101_016E" AS BIGINT) + TRY_CAST(src."B18101_019E" AS BIGINT) + TRY_CAST(src."B18101_023E" AS BIGINT) + TRY_CAST(src."B18101_026E" AS BIGINT) + TRY_CAST(src."B18101_029E" AS BIGINT) + TRY_CAST(src."B18101_032E" AS BIGINT) + TRY_CAST(src."B18101_035E" AS BIGINT) + TRY_CAST(src."B18101_038E" AS BIGINT)'
        comment: Population with a disability
      - name: hearing_difficulty
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B18102_004E" AS BIGINT)'
        comment: Population with hearing difficulty
      - name: vision_difficulty
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B18103_004E" AS BIGINT)'
        comment: Population with vision difficulty
      - name: cognitive_difficulty
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B18104_004E" AS BIGINT)'
        comment: Population with cognitive difficulty
      - name: ambulatory_difficulty
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B18105_004E" AS BIGINT)'
        comment: Population with ambulatory difficulty

    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B18101_001E,B18101_004E,B18101_007E,B18101_010E,B18101_013E,B18101_016E,B18101_019E,B18101_023E,B18101_026E,B18101_029E,B18101_032E,B18101_035E,B18101_038E,B18102_004E,B18103_004E,B18104_004E,B18105_004E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_disability
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS VETERANS - Veteran status
  # ---------------------------------------------------------------------------
  - name: acs_veterans
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Veteran status from ACS including veteran population by period of service.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: civilian_population_18_plus
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B21001_001E" AS BIGINT)'
        comment: Civilian population 18 years and over
      - name: veterans
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B21001_002E" AS BIGINT)'
        comment: Veteran population
      - name: nonveterans
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B21001_003E" AS BIGINT)'
        comment: Nonveteran population
      - name: male_veterans
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B21001_005E" AS BIGINT)'
        comment: Male veterans
      - name: female_veterans
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B21001_023E" AS BIGINT)'
        comment: Female veterans

    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B21001_001E,B21001_002E,B21001_003E,B21001_005E,B21001_023E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_veterans
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS MIGRATION - Geographic mobility in the past year
  # ---------------------------------------------------------------------------
  - name: acs_migration
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Geographic mobility from ACS showing where people moved from in the past year.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: population_1_year_plus
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B07001_001E" AS BIGINT)'
        comment: Population 1 year and over
      - name: same_house
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B07001_017E" AS BIGINT)'
        comment: Same house 1 year ago
      - name: moved_within_county
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B07001_033E" AS BIGINT)'
        comment: Moved within same county
      - name: moved_from_different_county_same_state
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B07001_049E" AS BIGINT)'
        comment: Moved from different county, same state
      - name: moved_from_different_state
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B07001_065E" AS BIGINT)'
        comment: Moved from different state
      - name: moved_from_abroad
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B07001_081E" AS BIGINT)'
        comment: Moved from abroad

    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B07001_001E,B07001_017E,B07001_033E,B07001_049E,B07001_065E,B07001_081E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_migration
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS OCCUPATION - Employment by occupation
  # ---------------------------------------------------------------------------
  - name: acs_occupation
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Employment by occupation category from ACS.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: total_employed
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24010_001E" AS BIGINT)'
        comment: Total employed civilian population 16+
      - name: management_business_science_arts
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24010_003E" AS BIGINT)'
        comment: Management, business, science, and arts occupations
      - name: service_occupations
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24010_019E" AS BIGINT)'
        comment: Service occupations
      - name: sales_office
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24010_027E" AS BIGINT)'
        comment: Sales and office occupations
      - name: natural_resources_construction_maintenance
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24010_030E" AS BIGINT)'
        comment: Natural resources, construction, and maintenance occupations
      - name: production_transportation_moving
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24010_037E" AS BIGINT)'
        comment: Production, transportation, and material moving occupations

    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,C24010_001E,C24010_003E,C24010_019E,C24010_027E,C24010_030E,C24010_037E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_occupation
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS INDUSTRY - Employment by industry
  # ---------------------------------------------------------------------------
  - name: acs_industry
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Employment by industry sector from ACS.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: total_employed
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24030_001E" AS BIGINT)'
        comment: Total employed civilian population 16+
      - name: agriculture_forestry_mining
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24030_003E" AS BIGINT)'
        comment: Agriculture, forestry, fishing, hunting, and mining
      - name: construction
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24030_006E" AS BIGINT)'
        comment: Construction
      - name: manufacturing
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24030_007E" AS BIGINT)'
        comment: Manufacturing
      - name: wholesale_trade
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24030_008E" AS BIGINT)'
        comment: Wholesale trade
      - name: retail_trade
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24030_009E" AS BIGINT)'
        comment: Retail trade
      - name: transportation_utilities
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24030_010E" AS BIGINT)'
        comment: Transportation and warehousing, and utilities
      - name: information
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24030_013E" AS BIGINT)'
        comment: Information
      - name: finance_insurance_real_estate
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24030_014E" AS BIGINT)'
        comment: Finance and insurance, and real estate
      - name: professional_scientific_management
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24030_017E" AS BIGINT)'
        comment: Professional, scientific, management, admin, and waste management
      - name: educational_healthcare_social
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24030_021E" AS BIGINT)'
        comment: Educational services, health care, and social assistance
      - name: arts_entertainment_recreation_food
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24030_024E" AS BIGINT)'
        comment: Arts, entertainment, recreation, accommodation, and food services
      - name: other_services
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24030_027E" AS BIGINT)'
        comment: Other services (except public administration)
      - name: public_administration
        type: long
        nullable: true
        expression: 'TRY_CAST(src."C24030_028E" AS BIGINT)'
        comment: Public administration

    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,C24030_001E,C24030_003E,C24030_006E,C24030_007E,C24030_008E,C24030_009E,C24030_010E,C24030_013E,C24030_014E,C24030_017E,C24030_021E,C24030_024E,C24030_027E,C24030_028E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_industry
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS INTERNET - Internet and computer access
  # ---------------------------------------------------------------------------
  - name: acs_internet
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Internet and computer access from ACS showing digital connectivity.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: total_households
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B28002_001E" AS BIGINT)'
        comment: Total households
      - name: with_internet
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B28002_002E" AS BIGINT)'
        comment: Households with an internet subscription
      - name: with_broadband
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B28002_004E" AS BIGINT)'
        comment: Households with broadband internet
      - name: no_internet
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B28002_013E" AS BIGINT)'
        comment: Households without internet access
      - name: with_computer
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B28001_002E" AS BIGINT)'
        comment: Households with a computer
      - name: no_computer
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B28001_011E" AS BIGINT)'
        comment: Households without a computer

    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B28002_001E,B28002_002E,B28002_004E,B28002_013E,B28001_002E,B28001_011E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_internet
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS NATIVITY - Nativity and citizenship status
  # ---------------------------------------------------------------------------
  - name: acs_nativity
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Nativity and citizenship status from ACS including foreign-born population.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: total_population
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B05001_001E" AS BIGINT)'
        comment: Total population
      - name: native_born
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B05001_002E" AS BIGINT)'
        comment: Native born (US citizen at birth)
      - name: foreign_born
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B05001_006E" AS BIGINT)'
        comment: Foreign born
      - name: naturalized_citizen
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B05001_005E" AS BIGINT)'
        comment: Naturalized US citizen
      - name: not_a_citizen
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B05001_006E" AS BIGINT)'
        comment: Not a US citizen

    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B05001_001E,B05001_002E,B05001_005E,B05001_006E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_nativity
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS MARITAL STATUS - Marital status
  # ---------------------------------------------------------------------------
  - name: acs_marital_status
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Marital status from ACS for population 15 years and over.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    # Columns match Census ACS API response field names (B12001 table = Sex by Marital Status)
    # snake_case names with source mapping to original Census API variable codes
    columns:
      - name: name
        type: string
        source: NAME
        nullable: true
        comment: Geographic area name from Census API
      - name: state
        type: string
        nullable: true
        comment: State FIPS code (2 digits)
      - name: county
        type: string
        nullable: true
        comment: County FIPS code (3 digits, within state)
      - name: b12001_001e
        type: string
        source: B12001_001E
        nullable: true
        comment: Population 15 years and over (total)
      - name: b12001_003e
        type: string
        source: B12001_003E
        nullable: true
        comment: Male never married
      - name: b12001_004e
        type: string
        source: B12001_004E
        nullable: true
        comment: Male now married (excluding separated)
      - name: b12001_006e
        type: string
        source: B12001_006E
        nullable: true
        comment: Male separated
      - name: b12001_009e
        type: string
        source: B12001_009E
        nullable: true
        comment: Male widowed
      - name: b12001_010e
        type: string
        source: B12001_010E
        nullable: true
        comment: Male divorced
      - name: b12001_012e
        type: string
        source: B12001_012E
        nullable: true
        comment: Female never married
      - name: b12001_013e
        type: string
        source: B12001_013E
        nullable: true
        comment: Female now married (excluding separated)
      - name: b12001_015e
        type: string
        source: B12001_015E
        nullable: true
        comment: Female separated
      - name: b12001_018e
        type: string
        source: B12001_018E
        nullable: true
        comment: Female widowed
      - name: b12001_019e
        type: string
        source: B12001_019E
        nullable: true
        comment: Female divorced

    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B12001_001E,B12001_003E,B12001_004E,B12001_006E,B12001_009E,B12001_010E,B12001_012E,B12001_013E,B12001_015E,B12001_018E,B12001_019E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_marital_status
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS HOUSEHOLD TYPE - Household and family composition
  # ---------------------------------------------------------------------------
  - name: acs_household_type
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Household type and family composition from ACS.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: total_households
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B11001_001E" AS BIGINT)'
        comment: Total households
      - name: family_households
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B11001_002E" AS BIGINT)'
        comment: Family households
      - name: married_couple_family
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B11001_003E" AS BIGINT)'
        comment: Married-couple family
      - name: male_householder_no_spouse
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B11001_005E" AS BIGINT)'
        comment: Male householder, no spouse present
      - name: female_householder_no_spouse
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B11001_006E" AS BIGINT)'
        comment: Female householder, no spouse present
      - name: nonfamily_households
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B11001_007E" AS BIGINT)'
        comment: Nonfamily households
      - name: living_alone
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B11001_008E" AS BIGINT)'
        comment: Householder living alone
      - name: average_household_size
        type: double
        nullable: true
        expression: 'TRY_CAST(src."B25010_001E" AS DOUBLE)'
        comment: Average household size

    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B11001_001E,B11001_002E,B11001_003E,B11001_005E,B11001_006E,B11001_007E,B11001_008E,B25010_001E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_household_type
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS HOUSING TENURE - Homeownership and rental status
  # ---------------------------------------------------------------------------
  - name: acs_housing_tenure
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Housing tenure showing homeownership vs rental status from ACS.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: occupied_units
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B25003_001E" AS BIGINT)'
        comment: Total occupied housing units
      - name: owner_occupied
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B25003_002E" AS BIGINT)'
        comment: Owner-occupied units
      - name: renter_occupied
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B25003_003E" AS BIGINT)'
        comment: Renter-occupied units
      - name: median_home_value
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B25077_001E" AS BIGINT)'
        comment: Median value of owner-occupied units
      - name: median_gross_rent
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B25064_001E" AS BIGINT)'
        comment: Median gross rent
      - name: median_year_built
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B25035_001E" AS BIGINT)'
        comment: Median year structure built

    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B25003_001E,B25003_002E,B25003_003E,B25077_001E,B25064_001E,B25035_001E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_housing_tenure
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS INCOME DISTRIBUTION - Income brackets and Gini coefficient
  # ---------------------------------------------------------------------------
  - name: acs_income_distribution
    pattern: "type=acs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Household income distribution showing income brackets from ACS.

    dimensions:
      type:
        - acs
      year: *acs_year_range
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: total_households
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B19001_001E" AS BIGINT)'
        comment: Total households
      - name: income_under_10k
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B19001_002E" AS BIGINT)'
        comment: Households with income under $10,000
      - name: income_10k_to_25k
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B19001_003E" AS BIGINT) + TRY_CAST(src."B19001_004E" AS BIGINT) + TRY_CAST(src."B19001_005E" AS BIGINT)'
        comment: Households with income $10,000 to $24,999
      - name: income_25k_to_50k
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B19001_006E" AS BIGINT) + TRY_CAST(src."B19001_007E" AS BIGINT) + TRY_CAST(src."B19001_008E" AS BIGINT) + TRY_CAST(src."B19001_009E" AS BIGINT) + TRY_CAST(src."B19001_010E" AS BIGINT)'
        comment: Households with income $25,000 to $49,999
      - name: income_50k_to_100k
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B19001_011E" AS BIGINT) + TRY_CAST(src."B19001_012E" AS BIGINT) + TRY_CAST(src."B19001_013E" AS BIGINT)'
        comment: Households with income $50,000 to $99,999
      - name: income_100k_to_200k
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B19001_014E" AS BIGINT) + TRY_CAST(src."B19001_015E" AS BIGINT) + TRY_CAST(src."B19001_016E" AS BIGINT)'
        comment: Households with income $100,000 to $199,999
      - name: income_200k_plus
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B19001_017E" AS BIGINT)'
        comment: Households with income $200,000 or more
      - name: gini_index
        type: double
        nullable: true
        expression: 'TRY_CAST(src."B19083_001E" AS DOUBLE)'
        comment: Gini index of income inequality

    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs5?get=NAME,B19001_001E,B19001_002E,B19001_003E,B19001_004E,B19001_005E,B19001_006E,B19001_007E,B19001_008E,B19001_009E,B19001_010E,B19001_011E,B19001_012E,B19001_013E,B19001_014E,B19001_015E,B19001_016E,B19001_017E,B19083_001E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs_income_distribution
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # DECENNIAL HOUSING - Housing from decennial census
  # ---------------------------------------------------------------------------
  - name: decennial_housing
    pattern: "type=decennial/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Decennial Census housing unit counts and occupancy from 2000, 2010, 2020.

    dimensions:
      type:
        - decennial
      year: *decennial_years
      dataset:
        type: custom
      housing_variables:
        type: custom
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: total_housing_units
        type: long
        nullable: true
        expression: 'TRY_CAST(src."total_housing_units" AS BIGINT)'
        comment: Total housing units
      - name: occupied_units
        type: long
        nullable: true
        expression: 'TRY_CAST(src."occupied_housing_units" AS BIGINT)'
        comment: Occupied housing units
      - name: vacant_units
        type: long
        nullable: true
        expression: 'TRY_CAST(src."vacant_housing_units" AS BIGINT)'
        comment: Vacant housing units

    source:
      type: http
      url: "https://api.census.gov/data/{year}/dec/{dataset}?get=NAME,{housing_variables}&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"
      variableNormalizer: "org.apache.calcite.adapter.file.etl.MappingFileVariableNormalizer"
      variableNormalizerConfig:
        mappingFile: "census/census-variable-mappings.json"
        defaultType: "decennial"
      dimensionResolver: "org.apache.calcite.adapter.govdata.census.CensusDecennialDimensionResolver"

    materialize:
      format: iceberg
      output:
        pattern: "type=decennial/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: decennial_housing
        catalogType: hadoop

# ============================================================================
# POPULATION ESTIMATES PROGRAM (PEP)
# Annual population estimates between decennial censuses
# ============================================================================

  # ---------------------------------------------------------------------------
  # PEP POPULATION - Annual population estimates by state/county
  # ---------------------------------------------------------------------------
  - name: pep_population
    pattern: "type=pep/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Population Estimates Program (PEP) annual population estimates.
      Uses dimension resolver to handle API differences:
      - 2019 and earlier: pep/population endpoint with POP, DENSITY
      - 2020+: pep/charv endpoint with POP and YEAR filter

    dimensions:
      type:
        - pep
      year:
        - '2019'
        - '2020'
        - '2021'
        - '2022'
        - '2023'
      geography: *all_geographies
      # Dynamic dimensions resolved based on year - uses hooks.dimensionResolver
      endpoint:
        type: custom
      variables:
        type: custom
      vintage:
        type: custom
      year_filter:
        type: custom

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: population
        type: long
        nullable: true
        expression: 'TRY_CAST(src."POP" AS BIGINT)'
        comment: Total population estimate
      - name: density
        type: double
        nullable: true
        expression: 'TRY_CAST(src."DENSITY" AS DOUBLE)'
        comment: Population density (only for 2019 vintage)

    source:
      type: http
      url: "https://api.census.gov/data/{vintage}/{endpoint}?get=NAME,{variables}&for={geography}:*{year_filter}"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"
      dimensionResolver: "org.apache.calcite.adapter.govdata.census.CensusPepDimensionResolver"

    materialize:
      format: iceberg
      output:
        pattern: "type=pep/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: pep_population
        catalogType: hadoop

# ============================================================================
# COUNTY BUSINESS PATTERNS (CBP)
# Annual business establishment and employment data by industry
# ============================================================================

  # ---------------------------------------------------------------------------
  # CBP ESTABLISHMENTS - Business counts by industry and geography
  # ---------------------------------------------------------------------------
  - name: cbp_establishments
    pattern: "type=cbp/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      County Business Patterns provides annual data on business establishments,
      employment, and payroll by industry (NAICS) at state and county levels.

    dimensions:
      type:
        - cbp
      year:
        - '2020'
        - '2021'
        - '2022'
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: naics_code
        type: string
        nullable: true
        expression: 'src."NAICS2017"'
        comment: 2017 NAICS industry code
      - name: establishments
        type: long
        nullable: true
        expression: 'TRY_CAST(src."ESTAB" AS BIGINT)'
        comment: Number of establishments
      - name: employees
        type: long
        nullable: true
        expression: 'TRY_CAST(src."EMP" AS BIGINT)'
        comment: Number of employees (mid-March)
      - name: annual_payroll
        type: long
        nullable: true
        expression: 'TRY_CAST(src."PAYANN" AS BIGINT)'
        comment: Annual payroll ($1,000)
      - name: first_quarter_payroll
        type: long
        nullable: true
        expression: 'TRY_CAST(src."PAYQTR1" AS BIGINT)'
        comment: First quarter payroll ($1,000)

    source:
      type: http
      url: "https://api.census.gov/data/{year}/cbp?get=NAME,NAICS2017,ESTAB,EMP,PAYANN,PAYQTR1&for={geography}:*&NAICS2017=00"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=cbp/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: cbp_establishments
        catalogType: hadoop

# ============================================================================
# ACS 1-YEAR ESTIMATES
# More current data for areas with 65,000+ population
# ============================================================================

  # ---------------------------------------------------------------------------
  # ACS 1-YEAR POPULATION - Current year population estimates
  # ---------------------------------------------------------------------------
  - name: acs1_population
    pattern: "type=acs1/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      ACS 1-Year population estimates. More current than 5-year but only
      available for areas with 65,000+ population.

    dimensions:
      type:
        - acs1
      year:
        - '2022'
        - '2023'
        - '2024'
      geography:
        - state

    columns:
      - *name_column
      - *state_column
      - name: total_population
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B01001_001E" AS BIGINT)'
        comment: Total population
      - name: male_population
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B01001_002E" AS BIGINT)'
        comment: Male population
      - name: female_population
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B01001_026E" AS BIGINT)'
        comment: Female population
      - name: median_age
        type: double
        nullable: true
        expression: 'TRY_CAST(src."B01002_001E" AS DOUBLE)'
        comment: Median age

    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs1?get=NAME,B01001_001E,B01001_002E,B01001_026E,B01002_001E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs1/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs1_population
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # ACS 1-YEAR INCOME - Current year income statistics
  # ---------------------------------------------------------------------------
  - name: acs1_income
    pattern: "type=acs1/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      ACS 1-Year income statistics for areas with 65,000+ population.

    dimensions:
      type:
        - acs1
      year:
        - '2022'
        - '2023'
        - '2024'
      geography:
        - state

    columns:
      - *name_column
      - *state_column
      - name: median_household_income
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B19013_001E" AS BIGINT)'
        comment: Median household income
      - name: per_capita_income
        type: long
        nullable: true
        expression: 'TRY_CAST(src."B19301_001E" AS BIGINT)'
        comment: Per capita income

    source:
      type: http
      url: "https://api.census.gov/data/{year}/acs/acs1?get=NAME,B19013_001E,B19301_001E&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=acs1/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: acs1_income
        catalogType: hadoop

# ============================================================================
# ECONOMIC CENSUS
# Comprehensive business statistics (every 5 years)
# ============================================================================

  # ---------------------------------------------------------------------------
  # ECONOMIC CENSUS BASIC - Core business statistics
  # ---------------------------------------------------------------------------
  - name: economic_census
    pattern: "type=ecn/year=*/*.parquet"
    partitions:
      style: hive
      columnDefinitions:
        - name: type
          type: VARCHAR
        - name: year
          type: INTEGER
    comment: >
      Economic Census provides comprehensive business statistics including
      establishments, employment, payroll, and sales by industry.
      Uses dimension resolver to handle NAICS version differences:
      - 2017: Uses NAICS2017 variable
      - 2022: Uses NAICS2022 variable
      Partitioned by year only (not geography) to reduce file count.

    dimensions:
      type:
        - ecn
      year:
        - '2017'
        - '2022'
      geography: *all_geographies
      # Dynamic NAICS variable resolved based on year - uses hooks.dimensionResolver
      naics_var:
        type: custom

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: naics_code
        type: string
        nullable: true
        expression: 'COALESCE(src."NAICS2017", src."NAICS2022")'
        comment: NAICS industry code (version depends on census year)
      - name: establishments
        type: long
        nullable: true
        expression: 'TRY_CAST(src."ESTAB" AS BIGINT)'
        comment: Number of establishments
      - name: employees
        type: long
        nullable: true
        expression: 'TRY_CAST(src."EMP" AS BIGINT)'
        comment: Number of employees
      - name: payroll
        type: long
        nullable: true
        expression: 'TRY_CAST(src."PAYANN" AS BIGINT)'
        comment: Annual payroll ($1,000)
      - name: sales
        type: long
        nullable: true
        expression: 'TRY_CAST(src."RCPTOT" AS BIGINT)'
        comment: Total sales/receipts ($1,000)

    source:
      type: http
      url: "https://api.census.gov/data/{year}/ecnbasic?get=NAME,{naics_var},ESTAB,EMP,PAYANN,RCPTOT&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"
      dimensionResolver: "org.apache.calcite.adapter.govdata.census.CensusEconomicDimensionResolver"

    materialize:
      format: iceberg
      output:
        pattern: "type=ecn/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: economic_census
        catalogType: hadoop

# ============================================================================
# SAIPE - SMALL AREA INCOME AND POVERTY ESTIMATES
# County and school district level poverty statistics
# ============================================================================

  # ---------------------------------------------------------------------------
  # SAIPE POVERTY - County-level poverty estimates
  # ---------------------------------------------------------------------------
  - name: saipe_poverty
    pattern: "type=saipe/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Small Area Income and Poverty Estimates (SAIPE) provides annual county-level
      estimates of income and poverty including median household income and
      poverty rates by age group.

    dimensions:
      type:
        - saipe
      year:
        - '2020'
        - '2021'
        - '2022'
        - '2023'
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: all_ages_poverty_count
        type: long
        nullable: true
        expression: 'TRY_CAST(src."SAEPOVALL_PT" AS BIGINT)'
        comment: All ages in poverty count estimate
      - name: all_ages_poverty_rate
        type: double
        nullable: true
        expression: 'TRY_CAST(src."SAEPOVRTALL_PT" AS DOUBLE)'
        comment: All ages poverty rate estimate
      - name: child_poverty_count
        type: long
        nullable: true
        expression: 'TRY_CAST(src."SAEPOV0_17_PT" AS BIGINT)'
        comment: Ages 0-17 in poverty count estimate
      - name: child_poverty_rate
        type: double
        nullable: true
        expression: 'TRY_CAST(src."SAEPOVRT0_17_PT" AS DOUBLE)'
        comment: Ages 0-17 poverty rate estimate
      - name: median_household_income
        type: long
        nullable: true
        expression: 'TRY_CAST(src."SAEMHI_PT" AS BIGINT)'
        comment: Median household income estimate

    source:
      type: http
      url: "https://api.census.gov/data/timeseries/poverty/saipe?get=NAME,SAEPOVALL_PT,SAEPOVRTALL_PT,SAEPOV0_17_PT,SAEPOVRT0_17_PT,SAEMHI_PT&for={geography}:*&YEAR={year}"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=saipe/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: saipe_poverty
        catalogType: hadoop

# ============================================================================
# SAHIE - SMALL AREA HEALTH INSURANCE ESTIMATES
# County-level health insurance coverage statistics
# ============================================================================

  # ---------------------------------------------------------------------------
  # SAHIE INSURANCE - Health insurance coverage estimates
  # ---------------------------------------------------------------------------
  - name: sahie_insurance
    pattern: "type=sahie/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Small Area Health Insurance Estimates (SAHIE) provides county-level
      estimates of health insurance coverage rates.

    dimensions:
      type:
        - sahie
      year:
        - '2020'
        - '2021'
        - '2022'
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: insured_count
        type: long
        nullable: true
        expression: 'TRY_CAST(src."NIC_PT" AS BIGINT)'
        comment: Number insured estimate
      - name: uninsured_count
        type: long
        nullable: true
        expression: 'TRY_CAST(src."NUI_PT" AS BIGINT)'
        comment: Number uninsured estimate
      - name: insured_rate
        type: double
        nullable: true
        expression: 'TRY_CAST(src."PCTIC_PT" AS DOUBLE)'
        comment: Percent insured estimate
      - name: uninsured_rate
        type: double
        nullable: true
        expression: 'TRY_CAST(src."PCTUI_PT" AS DOUBLE)'
        comment: Percent uninsured estimate

    source:
      type: http
      url: "https://api.census.gov/data/timeseries/healthins/sahie?get=NAME,NIC_PT,NUI_PT,PCTIC_PT,PCTUI_PT&for={geography}:*&time={year}"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=sahie/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: sahie_insurance
        catalogType: hadoop

# ============================================================================
# BUSINESS DYNAMICS STATISTICS (BDS)
# Firm-level job creation and destruction
# ============================================================================

  # ---------------------------------------------------------------------------
  # BDS DYNAMICS - Job creation and destruction by state
  # ---------------------------------------------------------------------------
  - name: bds_dynamics
    pattern: "type=bds/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Business Dynamics Statistics tracks job creation, destruction, firm
      births and deaths at state level by industry and firm characteristics.

    dimensions:
      type:
        - bds
      year:
        - '2020'
        - '2021'
        - '2022'
        - '2023'
      geography:
        - state

    columns:
      - *name_column
      - *state_column
      - name: job_creation
        type: long
        nullable: true
        expression: 'TRY_CAST(src."JOB_CREATION" AS BIGINT)'
        comment: Number of jobs created
      - name: job_destruction
        type: long
        nullable: true
        expression: 'TRY_CAST(src."JOB_DESTRUCTION" AS BIGINT)'
        comment: Number of jobs destroyed
      - name: net_job_creation
        type: long
        nullable: true
        expression: 'TRY_CAST(src."NET_JOB_CREATION" AS BIGINT)'
        comment: Net job creation (creation - destruction)
      - name: establishments
        type: long
        nullable: true
        expression: 'TRY_CAST(src."ESTAB" AS BIGINT)'
        comment: Number of establishments
      - name: firms
        type: long
        nullable: true
        expression: 'TRY_CAST(src."FIRM" AS BIGINT)'
        comment: Number of firms
      - name: employees
        type: long
        nullable: true
        expression: 'TRY_CAST(src."EMP" AS BIGINT)'
        comment: Number of employees

    source:
      type: http
      url: "https://api.census.gov/data/timeseries/bds?get=NAME,JOB_CREATION,JOB_DESTRUCTION,NET_JOB_CREATION,ESTAB,FIRM,EMP&for={geography}:*&YEAR={year}"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=bds/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: bds_dynamics
        catalogType: hadoop

# ============================================================================
# ANNUAL BUSINESS SURVEY (ABS)
# Business owner characteristics
# ============================================================================

  # ---------------------------------------------------------------------------
  # ABS CHARACTERISTICS - Business owner demographics
  # ---------------------------------------------------------------------------
  - name: abs_characteristics
    pattern: "type=abs/year=*/geography=*/*.parquet"
    partitions: *standard_partitions
    comment: >
      Annual Business Survey provides data on business owner characteristics
      including demographics, education, and veteran status.

    dimensions:
      type:
        - abs
      year:
        - '2021'
        - '2022'
      geography:
        - state

    columns:
      - *name_column
      - *state_column
      - name: firms
        type: long
        nullable: true
        expression: 'TRY_CAST(src."FIRMPDEMP" AS BIGINT)'
        comment: Number of employer firms
      - name: receipts
        type: long
        nullable: true
        expression: 'TRY_CAST(src."RCPPDEMP" AS BIGINT)'
        comment: Sales receipts ($1,000)
      - name: employees
        type: long
        nullable: true
        expression: 'TRY_CAST(src."EMP" AS BIGINT)'
        comment: Number of employees
      - name: payroll
        type: long
        nullable: true
        expression: 'TRY_CAST(src."PAYANN" AS BIGINT)'
        comment: Annual payroll ($1,000)

    source:
      type: http
      url: "https://api.census.gov/data/{year}/abscs?get=NAME,FIRMPDEMP,RCPPDEMP,EMP,PAYANN&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=abs/year=*/geography=*/"
      partition:
        columns: [type, year, geography]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: abs_characteristics
        catalogType: hadoop

# ============================================================================
# NONEMPLOYER STATISTICS
# Self-employed businesses without paid employees
# ============================================================================

  # ---------------------------------------------------------------------------
  # NONEMPLOYER STATISTICS - Self-employed business counts
  # ---------------------------------------------------------------------------
  - name: nonemployer_statistics
    pattern: "type=nonemp/year=*/*.parquet"
    partitions:
      style: hive
      columnDefinitions:
        - name: type
          type: VARCHAR
        - name: year
          type: INTEGER
    comment: >
      Nonemployer Statistics covers businesses with no paid employees,
      typically self-employed individuals operating unincorporated businesses.
      Partitioned by year only (not geography) to reduce file count.

    dimensions:
      type:
        - nonemp
      year:
        - '2019'
        - '2020'
        - '2021'
      geography: *all_geographies

    columns:
      - *name_column
      - *state_column
      - *county_column
      - *county_fips_column
      - name: naics_code
        type: string
        nullable: true
        expression: 'src."NAICS2017"'
        comment: NAICS industry code
      - name: establishments
        type: long
        nullable: true
        expression: 'TRY_CAST(src."NESTAB" AS BIGINT)'
        comment: Number of nonemployer establishments
      - name: receipts
        type: long
        nullable: true
        expression: 'TRY_CAST(src."NRCPTOT" AS BIGINT)'
        comment: Total receipts ($1,000)

    source:
      type: http
      # Uses NESTAB and NRCPTOT (N prefix for nonemployer)
      url: "https://api.census.gov/data/{year}/nonemp?get=NAME,NAICS2017,NESTAB,NRCPTOT&for={geography}:*"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=nonemp/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: nonemployer_statistics
        catalogType: hadoop

# ============================================================================
# BUILDING PERMITS SURVEY
# New residential construction permits
# ============================================================================

  # ---------------------------------------------------------------------------
  # BUILDING PERMITS - Residential construction activity
  # ---------------------------------------------------------------------------
  - name: building_permits
    pattern: "type=bps/year=*/*.parquet"
    partitions:
      style: hive
      columnDefinitions:
        - name: type
          type: VARCHAR
        - name: year
          type: VARCHAR
    comment: >
      Building Permits Survey tracks new privately-owned residential
      construction permits by state. Uses December cumulative (YTD) totals.
      Data from https://www2.census.gov/econ/bps/State/
      URL format is stYYMMy.txt where YYMM is year-month code (e.g., 2212 = Dec 2022).
      Partition 'year' stores the YYMM code for URL compatibility; actual year derived from survey_date.

    dimensions:
      type:
        - bps
      # URL code in YYMM format - serves as both partition key and URL parameter
      # December (12) cumulative data for each year
      year:
        - '2012'  # December 2020
        - '2112'  # December 2021
        - '2212'  # December 2022
        - '2312'  # December 2023
        - '2412'  # December 2024

    # Columns match Census Building Permits Survey fixed-width text file format
    # Data parsed from https://www2.census.gov/econ/bps/State/stYYMMy.txt
    columns:
      - name: column0
        type: string
        nullable: true
        comment: Survey date in YYYYMM format
      - name: column1
        type: string
        nullable: true
        comment: State FIPS code (2-digit)
      - name: column4
        type: string
        nullable: true
        comment: State name
      - name: column6
        type: string
        nullable: true
        comment: Single-family housing units authorized
      - name: column7
        type: string
        nullable: true
        comment: Value of single-family permits ($1000)
      - name: column9
        type: string
        nullable: true
        comment: Duplex housing units authorized
      - name: column10
        type: string
        nullable: true
        comment: Value of duplex permits ($1000)
      - name: column12
        type: string
        nullable: true
        comment: 3-4 unit housing units authorized
      - name: column13
        type: string
        nullable: true
        comment: Value of 3-4 unit permits ($1000)
      - name: column15
        type: string
        nullable: true
        comment: 5+ unit housing units authorized
      - name: column16
        type: string
        nullable: true
        comment: Value of 5+ unit permits ($1000)

    source:
      type: http
      url: "https://www2.census.gov/econ/bps/State/st{year}y.txt"
      response:
        format: csv
      rawCache:
        enabled: true
      # Filter to only include data rows (6-digit survey_date in first column)
      # and state-level data (2-digit FIPS, not US/R1-R4/D1-D9)
      rowFilter:
        column: column0
        pattern: '^\d{6}$'

    materialize:
      format: iceberg
      output:
        pattern: "type=bps/year=*/"
      partition:
        columns: [type, year]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: building_permits
        catalogType: hadoop

# ============================================================================
# QUARTERLY WORKFORCE INDICATORS (QWI)
# Employment dynamics by demographics
# ============================================================================

  # ---------------------------------------------------------------------------
  # QWI EMPLOYMENT - Quarterly employment by sex and age
  # ---------------------------------------------------------------------------
  - name: qwi_employment
    pattern: "type=qwi/time=*/*.parquet"
    partitions:
      style: hive
      columnDefinitions:
        - name: type
          type: VARCHAR
        - name: time
          type: VARCHAR
    comment: >
      Quarterly Workforce Indicators tracks employment, earnings, job creation,
      and worker turnover by demographics (age, sex) and industry.
      Note: QWI API doesn't support wildcard states - must iterate per state.
      Partitioned by time (YYYY-QN format) to reduce file count vs per-state.

    dimensions:
      type:
        - qwi
      # QWI API uses time parameter in format "YYYY-QN"
      time:
        - '2022-Q1'
        - '2022-Q2'
        - '2022-Q3'
        - '2022-Q4'
        - '2023-Q1'
        - '2023-Q2'
        - '2023-Q3'
        - '2023-Q4'
        - '2024-Q1'
        - '2024-Q2'
        - '2024-Q3'
        - '2024-Q4'
      # QWI doesn't support wildcard - need explicit state FIPS codes
      # All 50 states + DC (FIPS 01-56, excluding 03, 07, 14, 43, 52)
      state: *all_state_fips

    columns:
      - *state_column
      - name: quarter
        type: string
        nullable: true
        expression: 'src."time"'
        comment: Quarter in YYYY-QN format
      - name: employment
        type: long
        nullable: true
        expression: 'TRY_CAST(src."Emp" AS BIGINT)'
        comment: Beginning-of-quarter employment
      - name: stable_employment
        type: long
        nullable: true
        expression: 'TRY_CAST(src."EmpS" AS BIGINT)'
        comment: Stable employment (employed full quarter)
      - name: hires
        type: long
        nullable: true
        expression: 'TRY_CAST(src."HirA" AS BIGINT)'
        comment: All hires
      - name: separations
        type: long
        nullable: true
        expression: 'TRY_CAST(src."Sep" AS BIGINT)'
        comment: All separations
      - name: earnings
        type: long
        nullable: true
        expression: 'TRY_CAST(src."EarnS" AS BIGINT)'
        comment: Average monthly earnings of stable workers

    source:
      type: http
      url: "https://api.census.gov/data/timeseries/qwi/sa?get=Emp,EmpS,HirA,Sep,EarnS&for=state:{state}&time={time}"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=qwi/time=*/"
      partition:
        columns: [type, time]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: qwi_employment
        catalogType: hadoop

# ============================================================================
# LEHD/LODES - Origin-Destination Employment Statistics
# Commuting patterns (file-based, not API)
# ============================================================================

  # ---------------------------------------------------------------------------
  # LODES WAC - Workplace Area Characteristics
  # ---------------------------------------------------------------------------
  - name: lodes_workplace
    pattern: "type=lodes/year=*/state=*/*.parquet"
    partitions:
      style: hive
      columns:
        - name: type
          type: string
        - name: year
          type: string
        - name: state
          type: string
    comment: >
      LEHD Origin-Destination Employment Statistics (LODES) Workplace Area
      Characteristics (WAC). Downloaded from lehd.ces.census.gov/data/lodes/.

    dimensions:
      type:
        - lodes
      year:
        - '2021'
        - '2022'
      state:
        - 'al'
        - 'ak'
        - 'az'
        - 'ar'
        - 'ca'
        - 'co'
        - 'ct'
        - 'de'
        - 'fl'
        - 'ga'

    # Columns match LODES WAC CSV file column names (snake_case with source mapping)
    # Data from https://lehd.ces.census.gov/data/lodes/
    columns:
      - name: w_geocode
        type: string
        nullable: true
        comment: Workplace census block code (15 digits)
      - name: c000
        type: string
        source: C000
        nullable: true
        comment: Total number of jobs
      - name: ca01
        type: string
        source: CA01
        nullable: true
        comment: Jobs for workers age 29 or younger
      - name: ca02
        type: string
        source: CA02
        nullable: true
        comment: Jobs for workers age 30 to 54
      - name: ca03
        type: string
        source: CA03
        nullable: true
        comment: Jobs for workers age 55 or older
      - name: ce01
        type: string
        source: CE01
        nullable: true
        comment: Jobs with monthly earnings $1,250 or less
      - name: ce02
        type: string
        source: CE02
        nullable: true
        comment: Jobs with monthly earnings $1,251 to $3,333
      - name: ce03
        type: string
        source: CE03
        nullable: true
        comment: Jobs with monthly earnings $3,333 or more

    source:
      type: http
      url: "https://lehd.ces.census.gov/data/lodes/LODES8/{state}/wac/{state}_wac_S000_JT00_{year}.csv.gz"
      response:
        format: csv
        compressed: gzip
      rawCache:
        enabled: true

    materialize:
      format: iceberg
      output:
        pattern: "type=lodes/year=*/state=*/"
      partition:
        columns: [type, year, state]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: lodes_workplace
        catalogType: hadoop

# ============================================================================
# INTERNATIONAL TRADE
# Import and export statistics
# ============================================================================

  # ---------------------------------------------------------------------------
  # TRADE EXPORTS - Annual exports by country
  # ---------------------------------------------------------------------------
  - name: trade_exports
    pattern: "type=trade/direction=exports/time=*/*.parquet"
    partitions:
      style: hive
      columns:
        - name: type
          type: string
        - name: direction
          type: string
        - name: time
          type: string
    comment: >
      International trade exports by destination country and commodity.

    dimensions:
      type:
        - trade
      direction:
        - exports
      # Trade API uses time=YYYY-MM format for December year-end totals
      time:
        - '2021-12'
        - '2022-12'
        - '2023-12'

    columns:
      - name: country_code
        type: string
        nullable: true
        expression: 'src."CTY_CODE"'
        comment: Destination country code
      - name: country_name
        type: string
        nullable: true
        expression: 'src."CTY_NAME"'
        comment: Destination country name
      - name: total_value
        type: long
        nullable: true
        expression: 'TRY_CAST(src."ALL_VAL_YR" AS BIGINT)'
        comment: Total export value year-to-date ($)

    source:
      type: http
      url: "https://api.census.gov/data/timeseries/intltrade/exports/enduse?get=CTY_CODE,CTY_NAME,ALL_VAL_YR&time={time}&E_ENDUSE=0"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=trade/direction=exports/time=*/"
      partition:
        columns: [type, direction, time]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: trade_exports
        catalogType: hadoop

  # ---------------------------------------------------------------------------
  # TRADE IMPORTS - Annual imports by country
  # ---------------------------------------------------------------------------
  - name: trade_imports
    pattern: "type=trade/direction=imports/time=*/*.parquet"
    partitions:
      style: hive
      columns:
        - name: type
          type: string
        - name: direction
          type: string
        - name: time
          type: string
    comment: >
      International trade imports by origin country and commodity.

    dimensions:
      type:
        - trade
      direction:
        - imports
      # Trade API uses time=YYYY-MM format for December year-end totals
      time:
        - '2021-12'
        - '2022-12'
        - '2023-12'

    columns:
      - name: country_code
        type: string
        nullable: true
        expression: 'src."CTY_CODE"'
        comment: Origin country code
      - name: country_name
        type: string
        nullable: true
        expression: 'src."CTY_NAME"'
        comment: Origin country name
      - name: total_value
        type: long
        nullable: true
        expression: 'TRY_CAST(src."GEN_VAL_YR" AS BIGINT)'
        comment: Total import value year-to-date ($)

    source:
      type: http
      url: "https://api.census.gov/data/timeseries/intltrade/imports/enduse?get=CTY_CODE,CTY_NAME,GEN_VAL_YR&time={time}&I_ENDUSE=0"
      method: GET
      response:
        format: json
      rateLimit:
        requestsPerSecond: 2.0
        retryOn: [429, 503]
      rawCache:
        enabled: true

    hooks:
      responseTransformer: "org.apache.calcite.adapter.govdata.geo.CensusResponseTransformer"

    materialize:
      format: iceberg
      output:
        pattern: "type=trade/direction=imports/time=*/"
      partition:
        columns: [type, direction, time]
      iceberg:
        warehousePath: "${GOVDATA_PARQUET_DIR}/source=census/CENSUS"
        tableName: trade_imports
        catalogType: hadoop

# ============================================================================
# SQL VIEWS
# ============================================================================
# Analytical views for aggregated Census data queries.
# These views reference the partitioned tables above.
# ============================================================================

tables:
  # ---------------------------------------------------------------------------
  # POPULATION_SUMMARY - State-level population trends
  # ---------------------------------------------------------------------------
  - name: population_summary
    type: view
    comment: >
      State-level population summary showing total, male, and female population
      by year. Aggregates data from acs_population table.
    sql: >
      SELECT
        state,
        geo_name,
        "year",
        total_population,
        male_population,
        female_population,
        ROUND(100.0 * male_population / NULLIF(total_population, 0), 2) AS male_pct,
        ROUND(100.0 * female_population / NULLIF(total_population, 0), 2) AS female_pct
      FROM acs_population
      WHERE geography = 'state'

  # ---------------------------------------------------------------------------
  # INCOME_SUMMARY - State-level income metrics
  # ---------------------------------------------------------------------------
  - name: income_summary
    type: view
    comment: >
      State-level income summary showing median household income and per capita
      income by year. Aggregates data from acs_income table.
    sql: >
      SELECT
        state,
        geo_name,
        "year",
        median_household_income,
        per_capita_income
      FROM acs_income
      WHERE geography = 'state'

  # ---------------------------------------------------------------------------
  # POVERTY_RATE - Poverty rate calculations
  # ---------------------------------------------------------------------------
  - name: poverty_rate
    type: view
    comment: >
      State-level poverty rates calculated from poverty universe and below poverty
      level counts. Shows percentage of population below poverty level.
    sql: >
      SELECT
        state,
        geo_name,
        "year",
        poverty_universe,
        below_poverty,
        ROUND(100.0 * below_poverty / NULLIF(poverty_universe, 0), 2) AS poverty_rate_pct
      FROM acs_poverty
      WHERE geography = 'state'

  # ---------------------------------------------------------------------------
  # EDUCATION_ATTAINMENT - Educational achievement metrics
  # ---------------------------------------------------------------------------
  - name: education_attainment
    type: view
    comment: >
      State-level educational attainment showing population with high school diploma,
      bachelor's degree, master's degree, and doctorate. Includes percentages.
    sql: >
      SELECT
        state,
        geo_name,
        "year",
        pop_25_plus,
        hs_graduate,
        bachelors,
        masters,
        doctorate,
        ROUND(100.0 * hs_graduate / NULLIF(pop_25_plus, 0), 2) AS hs_rate_pct,
        ROUND(100.0 * bachelors / NULLIF(pop_25_plus, 0), 2) AS bachelors_rate_pct,
        ROUND(100.0 * (masters + doctorate) / NULLIF(pop_25_plus, 0), 2) AS advanced_degree_pct
      FROM acs_education
      WHERE geography = 'state'

  # ---------------------------------------------------------------------------
  # UNEMPLOYMENT_RATE - Unemployment calculations
  # ---------------------------------------------------------------------------
  - name: unemployment_rate
    type: view
    comment: >
      State-level unemployment rates calculated from labor force and unemployed
      population. Shows labor force participation and unemployment percentages.
    sql: >
      SELECT
        state,
        geo_name,
        "year",
        labor_force,
        employed,
        unemployed,
        not_in_labor_force,
        ROUND(100.0 * unemployed / NULLIF(labor_force, 0), 2) AS unemployment_rate_pct,
        ROUND(100.0 * labor_force / NULLIF(labor_force + not_in_labor_force, 0), 2) AS labor_force_participation_pct
      FROM acs_employment
      WHERE geography = 'state'

# ============================================================================
# CONSTRAINTS
# ============================================================================
# Foreign key relationships to GEO schema for geographic joins
# ============================================================================

constraints:
  # ACS 5-Year Tables
  acs_population:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
        comment: Links census state data to geographic boundaries and state metadata
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]
        comment: Links census county data to geographic boundaries (when geography=county)

  acs_income:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_housing:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_education:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_employment:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_poverty:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  decennial_population:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_race_ethnicity:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_age_distribution:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_commute:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_occupation:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_language:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_disability:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_veterans:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_migration:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_industry_employment:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_industry_wages:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_internet:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_citizenship:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_marital_status:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_households:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_housing_tenure:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  acs_income_distribution:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  decennial_housing:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  population_estimates:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  cbp_establishments:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  # ACS 1-Year Tables
  acs1_population:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]

  acs1_income:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]

  # Economic Census
  economic_census:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  # SAIPE/SAHIE
  saipe:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  sahie:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

  # Business Data
  bds:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]

  abs:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]

  nonemp:
    foreignKeys:
      - columns: [state]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: states
        targetColumns: [state_fips]
      - columns: [county_fips]
        targetSchema: "${GEO_SCHEMA_NAME:geo}"
        targetTable: counties
        targetColumns: [county_fips]

# ============================================================================
# END OF SCHEMA
# ============================================================================
# STATISTICS:
#   - 22 ACS 5-Year partitioned tables
#   - 2 Decennial Census unified tables (population, housing)
#   - 1 PEP table (population estimates)
#   - 1 CBP table (county business patterns)
#   - 2 ACS 1-Year tables (population, income)
#   - 1 Economic Census table
#   - 1 SAIPE table (poverty estimates)
#   - 1 SAHIE table (health insurance)
#   - 1 BDS table (business dynamics)
#   - 1 ABS table (annual business survey)
#   - 1 Nonemployer table
#   - 1 Building Permits table
#   - 1 QWI table (workforce indicators)
#   - 1 LODES table (commuting patterns)
#   - 2 Trade tables (exports, imports)
#   - 5 SQL views (analytical aggregations)
#   - Total: 39 tables + 5 views
#   - Iceberg materialization with Hive partitioning
#   - Support for state and county level geographies
#   - Schema evolution: MappingFileVariableNormalizer + dimension resolvers
# ============================================================================
